<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">

<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.zhaojinxi.top","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.12.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="应教练要求，给学校搞个 OJ。 （就学校那电脑十几年没换了还部署什么 OJ）">
<meta property="og:type" content="article">
<meta property="og:title" content="SYZOJ 部署&amp;魔改记录">
<meta property="og:url" content="http://blog.zhaojinxi.top/2020/07/30/SYZOJ-bu-shu-mo-gai-ji-lu/">
<meta property="og:site_name" content="zhjxaoini&#39;s Blog">
<meta property="og:description" content="应教练要求，给学校搞个 OJ。 （就学校那电脑十几年没换了还部署什么 OJ）">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blog.zhaojinxi.top/2020/07/30/SYZOJ-bu-shu-mo-gai-ji-lu/noip1.png">
<meta property="og:image" content="http://blog.zhaojinxi.top/2020/07/30/SYZOJ-bu-shu-mo-gai-ji-lu/noip2.png">
<meta property="og:image" content="http://blog.zhaojinxi.top/2020/07/30/SYZOJ-bu-shu-mo-gai-ji-lu/noip3.png">
<meta property="og:image" content="http://blog.zhaojinxi.top/2020/07/30/SYZOJ-bu-shu-mo-gai-ji-lu/noip4.png">
<meta property="article:published_time" content="2020-07-30T13:29:25.000Z">
<meta property="article:modified_time" content="2022-07-07T05:28:26.377Z">
<meta property="article:author" content="zhjxaoini">
<meta property="article:tag" content="OJ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.zhaojinxi.top/2020/07/30/SYZOJ-bu-shu-mo-gai-ji-lu/noip1.png">


<link rel="canonical" href="http://blog.zhaojinxi.top/2020/07/30/SYZOJ-bu-shu-mo-gai-ji-lu/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://blog.zhaojinxi.top/2020/07/30/SYZOJ-bu-shu-mo-gai-ji-lu/","path":"2020/07/30/SYZOJ-bu-shu-mo-gai-ji-lu/","title":"SYZOJ 部署&魔改记录"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>SYZOJ 部署&魔改记录 | zhjxaoini's Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">zhjxaoini's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">2</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">2</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">3</span></a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2"><span class="nav-number">1.</span> <span class="nav-text">部署</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%AD%94%E6%94%B9"><span class="nav-number">2.</span> <span class="nav-text">魔改</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8D%E5%AD%97%E9%A2%9C%E8%89%B2"><span class="nav-number">2.1.</span> <span class="nav-text">名字颜色</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%98%BE%E7%A4%BA%E5%A7%93%E5%90%8D"><span class="nav-number">2.2.</span> <span class="nav-text">显示姓名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E6%88%B7-tag"><span class="nav-number">2.3.</span> <span class="nav-text">用户 Tag</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#logo"><span class="nav-number">2.4.</span> <span class="nav-text">Logo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%A8%E8%AE%BA%E4%BF%AE%E6%94%B9%E6%9D%83%E9%99%90"><span class="nav-number">2.5.</span> <span class="nav-text">讨论修改权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9E%E5%A4%8D%E5%88%A0%E9%99%A4%E6%9D%83%E9%99%90"><span class="nav-number">2.6.</span> <span class="nav-text">回复删除权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#testlib"><span class="nav-number">2.7.</span> <span class="nav-text">Testlib</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E5%AE%A1%E6%A0%B8%E5%8A%9F%E8%83%BD"><span class="nav-number">2.8.</span> <span class="nav-text">注册审核功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#noip-%E5%80%92%E8%AE%A1%E6%97%B6"><span class="nav-number">2.9.</span> <span class="nav-text">NOIp 倒计时</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AF%94%E8%B5%9B%E7%95%8C%E9%9D%A2"><span class="nav-number">2.10.</span> <span class="nav-text">比赛界面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%9C%E4%B8%9A%E5%8A%9F%E8%83%BD"><span class="nav-number">2.11.</span> <span class="nav-text">作业功能</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="zhjxaoini"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">zhjxaoini</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">3</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="mailto:zhjxaoini@outlook.com" title="E-Mail → mailto:zhjxaoini@outlook.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.luogu.com.cn/user/120026" title="Luogu → https:&#x2F;&#x2F;www.luogu.com.cn&#x2F;user&#x2F;120026" rel="noopener" target="_blank"><i class="fa fa-code fa-fw"></i>Luogu</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_nd.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://blog.zhaojinxi.top/2020/07/30/SYZOJ-bu-shu-mo-gai-ji-lu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="zhjxaoini">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zhjxaoini's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="SYZOJ 部署&魔改记录 | zhjxaoini's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SYZOJ 部署&魔改记录
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-07-30 21:29:25" itemprop="dateCreated datePublished" datetime="2020-07-30T21:29:25+08:00">2020-07-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>应教练要求，给学校搞个 OJ。</p>
<p><del>（就学校那电脑十几年没换了还部署什么 OJ）</del></p>
<span id="more"></span>
<h1 id="部署">部署</h1>
<p>一开始用的是 UOJ，但是不会 PHP，<del>为了魔改</del>于是换了
SYZOJ。</p>
<p>然后出了很多奇奇怪怪的错误，装了几次都没成功。</p>
<p>一直用的是清华的更新源，结果 potatoler
无意中发现把更新源换成阿里的就没有遇到之前的问题……</p>
<h1 id="魔改">魔改</h1>
<h2 id="名字颜色">名字颜色</h2>
<p>话说 SYZOJ 怎么都没有个按 rating 显示名字颜色的功能啊 <del>（隔壁 UOJ
早就有了</del></p>
<p>新建 static/self/custom.css 并加入每种颜色的样式：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.user-gray</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="built_in">rgb</span>(<span class="number">191</span>, <span class="number">191</span>, <span class="number">191</span>) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.user-blue</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="built_in">rgb</span>(<span class="number">52</span>, <span class="number">152</span>, <span class="number">219</span>) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.user-green</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="built_in">rgb</span>(<span class="number">82</span>, <span class="number">196</span>, <span class="number">26</span>) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.user-orange</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="built_in">rgb</span>(<span class="number">243</span>, <span class="number">156</span>, <span class="number">17</span>) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.user-red</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="built_in">rgb</span>(<span class="number">254</span>, <span class="number">76</span>, <span class="number">97</span>) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.user-purple</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="built_in">rgb</span>(<span class="number">157</span>, <span class="number">61</span>, <span class="number">207</span>) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在 views/header.ejs 中加入
<code>&lt;link href="/self/custom.css" rel="stylesheet"&gt;</code>。</p>
<p>打开 utility.js，在 <code>module.exports</code>
中加入用于计算颜色的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">makeUserColor</span>(<span class="params">rating, is_admin</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (is_admin) <span class="keyword">return</span> <span class="string">&#x27;purple&#x27;</span>;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (rating &lt; <span class="number">1400</span>) <span class="keyword">return</span> <span class="string">&#x27;gray&#x27;</span>;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (rating &lt; <span class="number">1600</span>) <span class="keyword">return</span> <span class="string">&#x27;blue&#x27;</span>;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (rating &lt; <span class="number">1800</span>) <span class="keyword">return</span> <span class="string">&#x27;green&#x27;</span>;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (rating &lt; <span class="number">2000</span>) <span class="keyword">return</span> <span class="string">&#x27;orange&#x27;</span>;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">&#x27;red&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后就是在所有 ejs 文件中，将类似
<code>&lt;%= xxx.username %&gt;</code> 的代码改为
<code>&lt;span class="user-&lt;%= syzoj.utils.makeUserColor(xxx.rating, xxx.is_admin) %&gt;"&gt;&lt;%= xxx.username %&gt;&lt;/span&gt;</code>。</p>
<p>改完后发现用户名的字体太细，加上颜色后看着很不舒服，所以把用户名加粗一些。</p>
<p>在 static/self/custom.css 中加入：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.user-name</span> &#123;</span><br><span class="line">  <span class="attribute">font-weight</span>: bold;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在上面修改的代码中，把
<code>class="user-&lt;%= syzoj.utils.makeUserColor(xxx.rating, xxx.is_admin) %&gt;"</code>
改为
<code>class="user-name user-&lt;%= syzoj.utils.makeUserColor(xxx.rating, xxx.is_admin) %&gt;"</code>。</p>
<h2 id="显示姓名">显示姓名</h2>
<p>作为校内
OJ，为了方便辨识，所以要加这个功能。<del>（毕竟直接用姓名做用户名看着还是怪难受的（</del></p>
<p>数据库中用户有 nameplate 属性，代码中也有显示 nameplate
的处理，但是没有修改的接口，于是直接用 nameplate
表示姓名，添加一些代码即可。</p>
<p>首先是在注册页面加一个输入框，将以下代码加入 views/sign_up.ejs
中对应位置：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;nameplate&quot;</span>&gt;</span>姓名<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;nameplate&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后在这个文件中的 javascript 代码部分加入提交 nameplate 的代码：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> url: &#x27;/api/sign_up&#x27;,</span><br><span class="line"> type: &#x27;POST&#x27;,</span><br><span class="line"> async: true,</span><br><span class="line"> data: &#123;</span><br><span class="line">   username: $(&quot;#username&quot;).val(),</span><br><span class="line"><span class="addition">+  nameplate: $(&quot;#nameplate&quot;).val(),</span></span><br><span class="line">   password: password,</span><br><span class="line">   email: $(&quot;#email&quot;).val(),</span><br><span class="line">   prevUrl: &lt;%- serializejs(req.query.url || &#x27;/&#x27;) %&gt;</span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure>
<p>之后在 modules/api.js 中加入几段代码：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> let sendObj = &#123;</span><br><span class="line">   username: req.body.username,</span><br><span class="line">   password: req.body.password,</span><br><span class="line"><span class="addition">+  nameplate: req.body.nameplate,</span></span><br><span class="line">   email: req.body.email,</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> user = await User.create(&#123;</span><br><span class="line">   username: req.body.username,</span><br><span class="line">   password: req.body.password,</span><br><span class="line"><span class="addition">+  nameplate: req.body.nameplate,</span></span><br><span class="line">   email: req.body.email,</span><br><span class="line">   is_show: syzoj.config.default.user.show,</span><br><span class="line">   rating: syzoj.config.default.user.rating,</span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> user = await User.create(&#123;</span><br><span class="line">   username: obj.username,</span><br><span class="line">   password: obj.password,</span><br><span class="line"><span class="addition">+  nameplate: obj.nameplate,</span></span><br><span class="line">   email: obj.email,</span><br><span class="line">   is_show: syzoj.config.default.user.show,</span><br><span class="line">   rating: syzoj.config.default.user.rating,</span><br></pre></td></tr></table></figure>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> user = await User.create(&#123;</span><br><span class="line">   username: obj.username,</span><br><span class="line">   password: obj.password,</span><br><span class="line"><span class="addition">+  nameplate: obj.nameplate,</span></span><br><span class="line">   email: obj.email,</span><br><span class="line">   public_email: true</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>
<p>另外在修改个人信息的页面也要加入修改姓名的接口，所以在
views/user_edit.ejs 中加入代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;nameplate&quot;</span>&gt;</span>姓名<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;nameplate&quot;</span> <span class="attr">name</span>=<span class="string">&quot;nameplate&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&lt;%= edited_user.nameplate %&gt;&quot;</span>&lt;% <span class="attr">if</span> (!<span class="attr">user.allowedManage</span>) &#123; %&gt;</span> readonly&lt;% &#125; %&gt;&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后在 modules/user.js 中加入修改的代码：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> if (res.locals.user &amp;&amp; await res.locals.user.hasPrivilege(&#x27;manage_user&#x27;)) &#123;</span><br><span class="line">   if (!syzoj.utils.isValidUsername(req.body.username)) throw new ErrorMessage(&#x27;无效的用户名。&#x27;);</span><br><span class="line">   user.username = req.body.username;</span><br><span class="line">   user.email = req.body.email;</span><br><span class="line"><span class="addition">+  user.nameplate = req.body.nameplate;</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>为了让显示效果更美观，在 static/self/custom.css 中加一个样式：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.user-nameplate</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">6px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后在所有 ejs 文件中，将显示 nameplate 的代码改一下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-gray user-nameplate&quot;</span>&gt;</span>&lt;%= xxx.nameplate %&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>姓名就会在用户名的后面显示为灰色小字。</p>
<hr />
<p>改 views/sign_up.ejs 的时候还发现了这样一段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">alert</span>(<span class="string">&quot;注册确认邮件已经发送到您的邮箱的垃圾箱，点击邮件内的链接即可完成注册。&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>（………………？）</p>
<h2 id="用户-tag">用户 Tag</h2>
<p>在数据库中，每个用户有一个 nickname 属性，但在代码中没有关于 nickname
的任何操作，所以就直接用 nickname 储存 tag。</p>
<p>首先要在修改个人信息的页面加一个输入框，那么往 views/user_edit.ejs
里添加代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if (edited_user.nickname || user.is_admin) &#123; %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;nickname&quot;</span>&gt;</span>Tag<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;nickname&quot;</span> <span class="attr">name</span>=<span class="string">&quot;nickname&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&lt;%= edited_user.nickname %&gt;&quot;</span>&lt;% <span class="attr">if</span> (!<span class="attr">user.is_admin</span>) &#123; %&gt;</span> readonly&lt;% &#125; %&gt;&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure>
<p>然后在 modules/user.js 中加入修改的代码：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> if (res.locals.user &amp;&amp; res.locals.user.is_admin) &#123;</span><br><span class="line"><span class="addition">+  user.nickname = req.body.nickname;</span></span><br><span class="line">   if (!req.body.privileges) &#123;</span><br><span class="line">     req.body.privileges = [];</span><br><span class="line">   &#125; else if (!Array.isArray(req.body.privileges)) &#123;</span><br></pre></td></tr></table></figure>
<p>之后在 static/self/custom.css 中添加显示效果：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.bg-gray</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">rgb</span>(<span class="number">191</span>, <span class="number">191</span>, <span class="number">191</span>) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.bg-blue</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">rgb</span>(<span class="number">52</span>, <span class="number">152</span>, <span class="number">219</span>) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.bg-green</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">rgb</span>(<span class="number">82</span>, <span class="number">196</span>, <span class="number">26</span>) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.bg-orange</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">rgb</span>(<span class="number">243</span>, <span class="number">156</span>, <span class="number">17</span>) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.bg-red</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">rgb</span>(<span class="number">254</span>, <span class="number">76</span>, <span class="number">97</span>) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.bg-purple</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">rgb</span>(<span class="number">157</span>, <span class="number">61</span>, <span class="number">207</span>) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.user-tag</span> &#123;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span><br><span class="line">  <span class="attribute">display</span>: inline-block;</span><br><span class="line">  <span class="attribute">padding</span>: .<span class="number">3em</span> .<span class="number">5em</span>;</span><br><span class="line">  <span class="attribute">font-weight</span>: <span class="number">700</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#fff</span>;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">1</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">11px</span>;</span><br><span class="line">  <span class="attribute">margin</span>: .<span class="number">2em</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后修改所有 ejs 文件，在 username 和 nameplate 之间加入显示 tag
的代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if (xxx.nickname) &#123; %&gt;<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-tag bg-&lt;%= syzoj.utils.makeUserColor(xxx.rating, xxx.is_admin) %&gt;&quot;</span>&gt;</span>&lt;%- xxx.nickname %&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure>
<p>结果发现需要显示的内容太长，在有些位置显示时被拆成了两行，所以再修改一下有问题的位置。</p>
<p>views/index.ejs：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-&lt;th style=&quot;width: 170px; &quot;&gt;用户名&lt;/th&gt;</span></span><br><span class="line"><span class="addition">+&lt;th style=&quot;width: 200px; &quot;&gt;用户名&lt;/th&gt;</span></span><br></pre></td></tr></table></figure>
<p>views/discussion.ejs：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-&lt;th style=&quot;width: 10%; &quot;&gt;作者&lt;/th&gt;</span></span><br><span class="line"><span class="addition">+&lt;th style=&quot;width: 25%; &quot;&gt;作者&lt;/th&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="logo">Logo</h2>
<p>（感谢 potatoler 用一晚上的时间为 OJ 画的 logo）</p>
<p>在 views/header.ejs 中添加
<code>&lt;link rel="icon" href="xxx" type="image/x-icon"&gt;</code>，用于设置网页标题旁的
logo。</p>
<p>在这个文件中添加
<code>&lt;img src="xxx" style="width: 32px; height: 32px; margin-right: 16px;"&gt;</code>，用于设置顶栏上的
logo。</p>
<h2 id="讨论修改权限">讨论修改权限</h2>
<p>SYZOJ 的讨论区中，发帖人和全站管理员可以修改帖子。</p>
<p>感觉这个设定不太合适，决定去掉发帖人修改帖子的权限，再添加一个“管理社区”权限，可以修改所有讨论。</p>
<p>首先在 views/user_edit.ejs 中加入“管理社区”的选项：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui toggle &lt;% if (!allowedManagePrivilege) &#123; %&gt;disabled &lt;% &#125; %&gt;checkbox checkbox_privilege&quot;</span> <span class="attr">data-name</span>=<span class="string">&quot;manage_community&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> &lt;% <span class="attr">if</span> (!<span class="attr">allowedManagePrivilege</span>) &#123; %&gt;</span>disabled=&quot;disabled&quot; &lt;% &#125; %&gt;type=&quot;checkbox&quot;&lt;% if (edited_user.privileges.includes(&#x27;manage_community&#x27;)) &#123; %&gt; checked&lt;% &#125; %&gt;&gt;</span><br><span class="line">  <span class="tag">&lt;<span class="name">label</span>&gt;</span>管理社区<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后在 modules/discussion.js 中将
<code>await article.isAllowedEditBy(res.locals.user)</code> 改为
<code>res.locals.user.is_admin || await res.locals.user.hasPrivilege('manage_community')</code>。</p>
<h2 id="回复删除权限">回复删除权限</h2>
<p>同样还是去掉回复人删除回复的权限，再让“管理社区”权限可以删除回复。</p>
<p>在 modules/discussion.js 中将
<code>await comment.isAllowedEditBy(res.locals.user)</code> 改为
<code>res.locals.user.is_admin || await res.locals.user.hasPrivilege('manage_community')</code>。</p>
<h2 id="testlib">Testlib</h2>
<p>SYZOJ 不支持用 Testlib 写的
spj，为了加上这个功能，本来想着再魔改一下，但发现已经有改好的版本在 <a
target="_blank" rel="noopener" href="https://pastebin.com/3GANXMG7">pastebin</a> 上，直接放到
/opt/syzoj/sandbox/rootfs/usr/include/ 即可。</p>
<p>结果突然发现这个 Testlib 还有锅……不能处理 Partially Correct
的情况……</p>
<p>在这个 Testlib 中找到这句：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::string stringPoints = <span class="built_in">removeDoubleTrailingZeroes</span>(format(<span class="string">&quot;%.10f&quot;</span>, __testlib_points));</span><br></pre></td></tr></table></figure>
<p>改为</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::string stringPoints = format(<span class="string">&quot;%d&quot;</span>, (<span class="type">int</span>)(__testlib_points * <span class="number">100</span>));</span><br></pre></td></tr></table></figure>
<p>另外这个 Testlib 还不支持交互器，找到
<code>registerInteraction</code> 函数改为这样即可：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">registerInteraction</span> <span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    __testlib_ensuresPreconditions ();</span><br><span class="line">    testlibMode = _interactor;</span><br><span class="line">    __testlib_set_binary (stdin);</span><br><span class="line">    inf.<span class="built_in">init</span> (<span class="string">&quot;input&quot;</span>, _input);</span><br><span class="line">    ouf.<span class="built_in">init</span> (stdin, _output);</span><br><span class="line">    resultName = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    appesMode = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="注册审核功能">注册审核功能</h2>
<p>因为是校内 OJ，所以要加入注册审核功能，注册信息必须通过审核才可以使用
OJ。</p>
<p>但是当 OJ 还没有用户时，就无法注册用户，因为还没有管理员审核。</p>
<p>于是直接将注册审核捆绑到邮箱验证上，当邮箱验证关闭时也同时关闭注册审核。<del>（反正都是用于验证的）</del></p>
<p><del>（好然后又写了很多不可维护代码</del></p>
<hr />
<p>考虑在注册账号后将注册信息存入数据库，然后邮件通知管理员审核。</p>
<p>但这样又太麻烦，当有一个用户注册时就必须遍历一遍当前的所有用户，然后再判断是否为管理员。</p>
<p>于是改成当管理员登录 OJ 时查询数据库，将待审核用户显示在主页上。</p>
<p>这个功能因为 <del>（似乎）</del> 比较复杂，所以我负责后端，前端主要由
potatoler 编写。</p>
<hr />
<p>首先就需要一个用于存待审核用户的表，新建 models/pending_user.ts
文件并写入以下内容：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">TypeORM</span> <span class="keyword">from</span> <span class="string">&quot;typeorm&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Model</span> <span class="keyword">from</span> <span class="string">&quot;./common&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@TypeORM</span>.<span class="title class_">Entity</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">PendingUser</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;</span><br><span class="line">  <span class="meta">@TypeORM</span>.<span class="title class_">Index</span>()</span><br><span class="line">  <span class="meta">@TypeORM</span>.<span class="title class_">PrimaryColumn</span>(&#123;<span class="attr">type</span>: <span class="string">&quot;varchar&quot;</span>, <span class="attr">length</span>: <span class="number">80</span> &#125;)</span><br><span class="line">  <span class="attr">username</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@TypeORM</span>.<span class="title class_">Column</span>(&#123;<span class="attr">type</span>: <span class="string">&quot;varchar&quot;</span>, <span class="attr">length</span>: <span class="number">120</span> &#125;)</span><br><span class="line">  <span class="attr">password</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@TypeORM</span>.<span class="title class_">Column</span>(&#123;<span class="attr">type</span>: <span class="string">&quot;text&quot;</span> &#125;)</span><br><span class="line">  <span class="attr">nameplate</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@TypeORM</span>.<span class="title class_">Column</span>(&#123;<span class="attr">type</span>: <span class="string">&quot;integer&quot;</span> &#125;)</span><br><span class="line">  <span class="attr">sex</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@TypeORM</span>.<span class="title class_">Column</span>(&#123;<span class="attr">type</span>: <span class="string">&quot;varchar&quot;</span>, <span class="attr">length</span>: <span class="number">120</span> &#125;)</span><br><span class="line">  <span class="attr">email</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外还需要一个显示信息的页面，新建 views/info.ejs
并写入以下内容：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;% this.title = &#x27;信息&#x27; %&gt;</span><br><span class="line">&lt;% include header %&gt;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui info icon message&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;info icon&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;header&quot;</span>&gt;</span></span><br><span class="line">    &lt;%= info %&gt;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;% include footer %&gt;</span><br></pre></td></tr></table></figure>
<p>然后修改注册时的操作，在 modules/api.js 的开头加入
<code>let PendingUser = syzoj.model('pending_user');</code>，用于操作数据库中的待审核用户。</p>
<p>然后找到
<code>app.get('/api/sign_up_confirm', async (req, res) =&gt; &#123;</code>，去掉新建用户的操作，改为向待审核用户中添加：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">user = <span class="keyword">await</span> <span class="title class_">PendingUser</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">  <span class="attr">username</span>: obj.<span class="property">username</span>,</span><br><span class="line">  <span class="attr">password</span>: obj.<span class="property">password</span>,</span><br><span class="line">  <span class="attr">nameplate</span>: obj.<span class="property">nameplate</span>,</span><br><span class="line">  <span class="attr">sex</span>: obj.<span class="property">sex</span>,</span><br><span class="line">  <span class="attr">email</span>: obj.<span class="property">email</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">await</span> user.<span class="title function_">save</span>();</span><br><span class="line"></span><br><span class="line">res.<span class="title function_">render</span>(<span class="string">&#x27;info&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">info</span>: <span class="string">&#x27;请等待管理员审核。&#x27;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>另外还需要处理前端向 <code>/api/allow_user/:username</code> 和
<code>/api/block_user/:username</code> 发送的 post
请求，表示审核状态：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/api/allow_user/:username&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;请登录后继续。&#x27;</span>, &#123; <span class="string">&#x27;登录&#x27;</span>: syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;login&#x27;</span>], &#123; <span class="string">&#x27;url&#x27;</span>: req.<span class="property">originalUrl</span> &#125;) &#125;);</span><br><span class="line">    <span class="keyword">let</span> allowed = <span class="keyword">await</span> res.<span class="property">locals</span>.<span class="property">user</span>.<span class="title function_">hasPrivilege</span>(<span class="string">&#x27;manage_user&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!allowed) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;您没有权限进行此操作。&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> pending_user = <span class="keyword">await</span> <span class="title class_">PendingUser</span>.<span class="property">findOne</span> (&#123;</span><br><span class="line">      <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">username</span>: req.<span class="property">params</span>.<span class="property">username</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!pending_user) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;无此用户。&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">fromName</span>(req.<span class="property">params</span>.<span class="property">username</span>);</span><br><span class="line">    <span class="keyword">if</span> (user) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;用户名已被占用。&#x27;</span>);</span><br><span class="line">    user = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123; <span class="attr">where</span>: &#123; <span class="attr">email</span>: pending_user.<span class="property">email</span> &#125; &#125;);</span><br><span class="line">    <span class="keyword">if</span> (user) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;邮件地址已被占用。&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    user = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">      <span class="attr">username</span>: pending_user.<span class="property">username</span>,</span><br><span class="line">      <span class="attr">password</span>: pending_user.<span class="property">password</span>,</span><br><span class="line">      <span class="attr">nameplate</span>: pending_user.<span class="property">nameplate</span>,</span><br><span class="line">      <span class="attr">sex</span>: pending_user.<span class="property">sex</span>,</span><br><span class="line">      <span class="attr">email</span>: pending_user.<span class="property">email</span>,</span><br><span class="line">      <span class="attr">is_show</span>: syzoj.<span class="property">config</span>.<span class="property">default</span>.<span class="property">user</span>.<span class="property">show</span>,</span><br><span class="line">      <span class="attr">rating</span>: syzoj.<span class="property">config</span>.<span class="property">default</span>.<span class="property">user</span>.<span class="property">rating</span>,</span><br><span class="line">      <span class="attr">register_time</span>: <span class="built_in">parseInt</span>((<span class="keyword">new</span> <span class="title class_">Date</span>()).<span class="title function_">getTime</span>() / <span class="number">1000</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">await</span> user.<span class="title function_">save</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title class_">Email</span>.<span class="title function_">send</span>(pending_user.<span class="property">email</span>,</span><br><span class="line">        <span class="string">`<span class="subst">$&#123;pending_user.username&#125;</span> 的 <span class="subst">$&#123;syzoj.config.title&#125;</span> 注册审核通知`</span>,</span><br><span class="line">        <span class="string">`&lt;p&gt;您在 <span class="subst">$&#123;syzoj.config.title&#125;</span> 的注册已通过审核。&lt;/p&gt;`</span></span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> pending_user.<span class="title function_">destroy</span>();</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    syzoj.<span class="title function_">log</span>(e);</span><br><span class="line">    res.<span class="title function_">send</span>(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/api/block_user/:username&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;请登录后继续。&#x27;</span>, &#123; <span class="string">&#x27;登录&#x27;</span>: syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;login&#x27;</span>], &#123; <span class="string">&#x27;url&#x27;</span>: req.<span class="property">originalUrl</span> &#125;) &#125;);</span><br><span class="line">    <span class="keyword">let</span> allowed = <span class="keyword">await</span> res.<span class="property">locals</span>.<span class="property">user</span>.<span class="title function_">hasPrivilege</span>(<span class="string">&#x27;manage_user&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!allowed) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;您没有权限进行此操作。&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> pending_user = <span class="keyword">await</span> <span class="title class_">PendingUser</span>.<span class="property">findOne</span> (&#123;</span><br><span class="line">      <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">username</span>: req.<span class="property">params</span>.<span class="property">username</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!pending_user) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;无此用户。&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title class_">Email</span>.<span class="title function_">send</span>(pending_user.<span class="property">email</span>,</span><br><span class="line">        <span class="string">`<span class="subst">$&#123;pending_user.username&#125;</span> 的 <span class="subst">$&#123;syzoj.config.title&#125;</span> 注册审核通知`</span>,</span><br><span class="line">        <span class="string">`&lt;p&gt;您在 <span class="subst">$&#123;syzoj.config.title&#125;</span> 的注册已被拒绝。&lt;/p&gt;`</span></span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> pending_user.<span class="title function_">destroy</span>();</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    syzoj.<span class="title function_">log</span>(e);</span><br><span class="line">    res.<span class="title function_">send</span>(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>最后修改 modules/index.js，向前端传递权限信息和待审核用户。</p>
<p>先在开头加入
<code>let PendingUser = syzoj.model('pending_user');</code>，然后找到
<code>app.get('/', async (req, res) =&gt; &#123;</code>，修改其中加载页面的位置：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+let pending_user = await PendingUser.find ();</span></span><br><span class="line"></span><br><span class="line"> res.render(&#x27;index&#x27;, &#123;</span><br><span class="line">   ranklist: ranklist,</span><br><span class="line">   notices: notices,</span><br><span class="line">   fortune: fortune,</span><br><span class="line">   contests: contests,</span><br><span class="line">   problems: problems,</span><br><span class="line">   links: syzoj.config.links,</span><br><span class="line"><span class="deletion">-  is_logined: !!res.locals.user</span></span><br><span class="line"><span class="addition">+  is_logined: !!res.locals.user,</span></span><br><span class="line"><span class="addition">+  allowedManage: res.locals.user &amp;&amp; await res.locals.user.hasPrivilege(&#x27;manage_user&#x27;),</span></span><br><span class="line"><span class="addition">+  pending_user: pending_user</span></span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>
<p>对于前端部分，首先在 views/index.ejs
找到侧边栏，然后加入以下代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if (is_logined &amp;&amp; allowedManage &amp;&amp; pending_user &amp;&amp; pending_user.length) &#123; %&gt;</span><br><span class="line">  <span class="tag">&lt;<span class="name">h4</span> <span class="attr">class</span>=<span class="string">&quot;ui top attached block header&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;user icon&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>待审核用户<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui bottom attached segment&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;ui very basic center aligned table&quot;</span> <span class="attr">style</span>=<span class="string">&quot;table-layout: fixed; &quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">        &lt;%</span><br><span class="line">        for (let i = 0; i &lt; pending_user.length; i++) &#123;</span><br><span class="line">          let user = pending_user[i];</span><br><span class="line">        %&gt;</span><br><span class="line">          <span class="tag">&lt;<span class="name">tr</span> <span class="attr">id</span> = <span class="string">&quot;pending_&lt;%= user.username %&gt;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">style</span>=<span class="string">&quot;text-align:left;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-name user-blue&quot;</span>&gt;</span>&lt;%= user.username %&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-gray user-nameplate&quot;</span>&gt;</span>&lt;%= user.nameplate %&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">style</span>=<span class="string">&quot;width: 90px;&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">style</span>=<span class="string">&quot;width: 35px; padding-right: 5px; padding-left: 5px; padding-top: 5px; padding-bottom: 5px&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ui mini green right button&quot;</span> <span class="attr">onclick</span>=<span class="string">userAllow(</span>&quot;&lt;%= <span class="string">user.username</span> %&gt;</span>&quot;)&gt;</span><br><span class="line">                通过</span><br><span class="line">              <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">style</span>=<span class="string">&quot;width: 35px; padding-right: 5px; padding-left: 5px; padding-top: 5px; padding-bottom: 5px&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ui mini gray right button&quot;</span> <span class="attr">onclick</span>=<span class="string">userBlock(</span>&quot;&lt;%= <span class="string">user.username</span> %&gt;</span>&quot;)&gt;</span><br><span class="line">                忽略</span><br><span class="line">              <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        &lt;% &#125; %&gt;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure>
<p>然后在 script 部分加入点击按钮时的操作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">userAllow</span> (username) &#123;</span><br><span class="line">  $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;/api/allow_user/&#x27;</span> + username,</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    <span class="attr">async</span>: <span class="literal">true</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">let</span> nod = <span class="variable language_">document</span>.<span class="property">getElementById</span> (<span class="string">&quot;pending_&quot;</span> + username);</span><br><span class="line">  <span class="keyword">let</span> par = nod.<span class="property">parentNode</span>;</span><br><span class="line">  par.<span class="property">removeChild</span> (nod);</span><br><span class="line">  <span class="keyword">if</span> (!par.<span class="property">childElementCount</span>) &#123;</span><br><span class="line">    par.<span class="property">parentNode</span>.<span class="property">removeChild</span> (par);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">userBlock</span> (username) &#123;</span><br><span class="line">  $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;/api/block_user/&#x27;</span> + username,</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    <span class="attr">async</span>: <span class="literal">true</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">let</span> nod = <span class="variable language_">document</span>.<span class="property">getElementById</span> (<span class="string">&quot;pending_&quot;</span> + username);</span><br><span class="line">  <span class="keyword">let</span> par = nod.<span class="property">parentNode</span>;</span><br><span class="line">  par.<span class="property">removeChild</span> (nod);</span><br><span class="line">  <span class="keyword">if</span> (!par.<span class="property">childElementCount</span>) &#123;</span><br><span class="line">    par.<span class="property">parentNode</span>.<span class="property">removeChild</span> (par);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外，在注册页面加上一个提示信息：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;nameplate&quot;</span>&gt;</span>真实姓名<span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;color: red; font-weight: 500;&quot;</span>&gt;</span>真实姓名填写错误会影响管理员对该账号的审核<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>最后，因为修改了 ts 文件，所以需要执行 <code>yarn</code>
重新编译才会使修改生效。</p>
<h2 id="noip-倒计时">NOIp 倒计时</h2>
<p>在主页的侧边栏加一个 NOIp
倒计时的功能，再加上一个圆环形的类似进度条的东西，根据剩余时间改变颜色。</p>
<p>本来是用 css 做了很久，最后发现还是 svg 最方便。</p>
<p>首先显示一个灰色的圆环，然后再显示一个半径相同、宽度相同的环形虚线，设置虚线的间隔为大于环长的值，那么就可以显示出指定长度的圆弧。</p>
<p>在 views/index.ejs 中加入以下代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h4</span> <span class="attr">class</span>=<span class="string">&quot;ui top attached block header&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ui clock icon&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display: inline-block; margin-right: .75rem;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>距离 <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;color: &lt;%= noip_color %&gt;&quot;</span>&gt;</span>NOIp&lt;%= noip_year %&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span> 还有<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui bottom attached center aligned segment&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">&quot;140&quot;</span> <span class="attr">height</span>=<span class="string">&quot;140&quot;</span> <span class="attr">viewBox</span>=<span class="string">&quot;0 0 140 140&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">circle</span> <span class="attr">cx</span>=<span class="string">&quot;70&quot;</span> <span class="attr">cy</span>=<span class="string">&quot;70&quot;</span> <span class="attr">r</span>=<span class="string">&quot;65&quot;</span> <span class="attr">stroke-width</span>=<span class="string">&quot;10&quot;</span> <span class="attr">stroke</span>=<span class="string">&quot;#E5E5E5&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;none&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">circle</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">circle</span> <span class="attr">cx</span>=<span class="string">&quot;70&quot;</span> <span class="attr">cy</span>=<span class="string">&quot;70&quot;</span> <span class="attr">r</span>=<span class="string">&quot;65&quot;</span> <span class="attr">stroke-width</span>=<span class="string">&quot;10&quot;</span> <span class="attr">stroke</span>=<span class="string">&quot;&lt;%= noip_color %&gt;&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;none&quot;</span> <span class="attr">transform</span>=<span class="string">&quot;matrix(0, -1, 1, 0, 0, 140)&quot;</span> <span class="attr">stroke-dasharray</span>=<span class="string">&quot;&lt;%= noip_arc %&gt; 409&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">circle</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">style</span>=<span class="string">&quot;dominant-baseline:middle;text-anchor:middle;font-size: 30px;font-weight: 800; fill: &lt;%= noip_color %&gt;&quot;</span> <span class="attr">y</span>=<span class="string">&quot;70&quot;</span> <span class="attr">x</span>=<span class="string">&quot;70&quot;</span>&gt;</span>&lt;%= noip_day %&gt;天<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后在 modules/index.js 中加入以下内容：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> getNOIpDay = <span class="keyword">function</span> (<span class="params">year</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> fg = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> d;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt;= <span class="number">14</span>; ++i) &#123;</span><br><span class="line">    d = <span class="keyword">new</span> <span class="title class_">Date</span> (year, <span class="number">10</span>, i);</span><br><span class="line">    <span class="keyword">if</span> (d.<span class="property">getDay</span> () == <span class="number">6</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (fg) &#123;</span><br><span class="line">        <span class="keyword">return</span> d;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        fg = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> year = <span class="keyword">new</span> <span class="title class_">Date</span> ().<span class="property">getFullYear</span> ();</span><br><span class="line"><span class="keyword">let</span> day = <span class="built_in">parseInt</span> ((getNOIpDay (year) - <span class="keyword">new</span> <span class="title class_">Date</span> ()) / (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>));</span><br><span class="line"><span class="keyword">if</span> (day == -<span class="number">1</span>) &#123;</span><br><span class="line">  day = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (day &lt; -<span class="number">1</span>) &#123;</span><br><span class="line">  ++year;</span><br><span class="line">  day = <span class="built_in">parseInt</span> ((getNOIpDay (year) - <span class="keyword">new</span> <span class="title class_">Date</span> ()) / (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> noip_color;</span><br><span class="line"><span class="keyword">if</span> (day &lt;= <span class="number">91</span>) &#123;</span><br><span class="line">  noip_color = <span class="string">&quot;#e74c3c&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (day &lt;= <span class="number">182</span>) &#123;</span><br><span class="line">  noip_color = <span class="string">&quot;#e67e22&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (day &lt;= <span class="number">273</span>) &#123;</span><br><span class="line">  noip_color = <span class="string">&quot;#f1c40f&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  noip_color = <span class="string">&quot;#2dce89&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后再将数据传给前端：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> res.render(&#x27;index&#x27;, &#123;</span><br><span class="line">   ranklist: ranklist,</span><br><span class="line">   notices: notices,</span><br><span class="line">   fortune: fortune,</span><br><span class="line">   contests: contests,</span><br><span class="line">   problems: problems,</span><br><span class="line">   links: syzoj.config.links,</span><br><span class="line">   is_logined: !!res.locals.user,</span><br><span class="line">   allowedManage: res.locals.user &amp;&amp; res.locals.user.hasPrivilege(&#x27;manage_user&#x27;),</span><br><span class="line"><span class="deletion">-  pending_user: pending_user</span></span><br><span class="line"><span class="addition">+  pending_user: pending_user,</span></span><br><span class="line"><span class="addition">+  noip_year: year,</span></span><br><span class="line"><span class="addition">+  noip_day: day,</span></span><br><span class="line"><span class="addition">+  noip_color: noip_color,</span></span><br><span class="line"><span class="addition">+  noip_arc: day / 365 * 409</span></span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>
<p>就可以实现这样的效果：</p>
<img data-src="/2020/07/30/SYZOJ-bu-shu-mo-gai-ji-lu/noip1.png" class="">
<img data-src="/2020/07/30/SYZOJ-bu-shu-mo-gai-ji-lu/noip2.png" class="">
<img data-src="/2020/07/30/SYZOJ-bu-shu-mo-gai-ji-lu/noip3.png" class="">
<img data-src="/2020/07/30/SYZOJ-bu-shu-mo-gai-ji-lu/noip4.png" class="">
<h2 id="比赛界面">比赛界面</h2>
<p>因为在比赛界面中点击排行榜会跳到另一个页面，看不到原来的比赛信息，所以决定修改一下，同时也改了改其他部分。</p>
<p>modules/contest.js：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="title class_">Contest</span> = syzoj.<span class="title function_">model</span>(<span class="string">&#x27;contest&#x27;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="title class_">ContestRanklist</span> = syzoj.<span class="title function_">model</span>(<span class="string">&#x27;contest_ranklist&#x27;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="title class_">ContestPlayer</span> = syzoj.<span class="title function_">model</span>(<span class="string">&#x27;contest_player&#x27;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="title class_">Problem</span> = syzoj.<span class="title function_">model</span>(<span class="string">&#x27;problem&#x27;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="title class_">JudgeState</span> = syzoj.<span class="title function_">model</span>(<span class="string">&#x27;judge_state&#x27;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="title class_">User</span> = syzoj.<span class="title function_">model</span>(<span class="string">&#x27;user&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; getSubmissionInfo, getRoughResult, processOverallResult &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../libs/submissions_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/contests&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;请登录后继续。&#x27;</span>, &#123; <span class="string">&#x27;登录&#x27;</span>: syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;login&#x27;</span>], &#123; <span class="string">&#x27;url&#x27;</span>: req.<span class="property">originalUrl</span> &#125;) &#125;);</span><br><span class="line">    <span class="keyword">let</span> where;</span><br><span class="line">    <span class="keyword">if</span> (res.<span class="property">locals</span>.<span class="property">user</span> &amp;&amp; res.<span class="property">locals</span>.<span class="property">user</span>.<span class="property">is_admin</span>) where = &#123;&#125;</span><br><span class="line">    <span class="keyword">else</span> where = &#123; <span class="attr">is_public</span>: <span class="literal">true</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> paginate = syzoj.<span class="property">utils</span>.<span class="title function_">paginate</span>(<span class="keyword">await</span> <span class="title class_">Contest</span>.<span class="title function_">countForPagination</span>(where), req.<span class="property">query</span>.<span class="property">page</span>, syzoj.<span class="property">config</span>.<span class="property">page</span>.<span class="property">contest</span>);</span><br><span class="line">    <span class="keyword">let</span> contests = <span class="keyword">await</span> <span class="title class_">Contest</span>.<span class="title function_">queryPage</span>(paginate, where, &#123;</span><br><span class="line">      <span class="attr">start_time</span>: <span class="string">&#x27;DESC&#x27;</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> contests.<span class="title function_">forEachAsync</span>(<span class="keyword">async</span> x =&gt; x.<span class="property">subtitle</span> = <span class="keyword">await</span> syzoj.<span class="property">utils</span>.<span class="title function_">markdown</span>(x.<span class="property">subtitle</span>));</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;contests&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">contests</span>: contests,</span><br><span class="line">      <span class="attr">paginate</span>: paginate</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    syzoj.<span class="title function_">log</span>(e);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">err</span>: e</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/contest/:id/edit&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;请登录后继续。&#x27;</span>, &#123; <span class="string">&#x27;登录&#x27;</span>: syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;login&#x27;</span>], &#123; <span class="string">&#x27;url&#x27;</span>: req.<span class="property">originalUrl</span> &#125;) &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span> || !res.<span class="property">locals</span>.<span class="property">user</span>.<span class="property">is_admin</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;您没有权限进行此操作。&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> contest_id = <span class="built_in">parseInt</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">let</span> contest = <span class="keyword">await</span> <span class="title class_">Contest</span>.<span class="title function_">findById</span>(contest_id);</span><br><span class="line">    <span class="keyword">if</span> (!contest) &#123;</span><br><span class="line">      contest = <span class="keyword">await</span> <span class="title class_">Contest</span>.<span class="title function_">create</span>();</span><br><span class="line">      contest.<span class="property">id</span> = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> contest.<span class="title function_">loadRelationships</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> problems = [], admins = [];</span><br><span class="line">    <span class="keyword">if</span> (contest.<span class="property">problems</span>) problems = <span class="keyword">await</span> contest.<span class="property">problems</span>.<span class="title function_">split</span>(<span class="string">&#x27;|&#x27;</span>).<span class="title function_">mapAsync</span>(<span class="keyword">async</span> id =&gt; <span class="keyword">await</span> <span class="title class_">Problem</span>.<span class="title function_">findById</span>(id));</span><br><span class="line">    <span class="keyword">if</span> (contest.<span class="property">admins</span>) admins = <span class="keyword">await</span> contest.<span class="property">admins</span>.<span class="title function_">split</span>(<span class="string">&#x27;|&#x27;</span>).<span class="title function_">mapAsync</span>(<span class="keyword">async</span> id =&gt; <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findById</span>(id));</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;contest_edit&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">contest</span>: contest,</span><br><span class="line">      <span class="attr">problems</span>: problems,</span><br><span class="line">      <span class="attr">admins</span>: admins</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    syzoj.<span class="title function_">log</span>(e);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">err</span>: e</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/contest/:id/edit&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;请登录后继续。&#x27;</span>, &#123; <span class="string">&#x27;登录&#x27;</span>: syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;login&#x27;</span>], &#123; <span class="string">&#x27;url&#x27;</span>: req.<span class="property">originalUrl</span> &#125;) &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span> || !res.<span class="property">locals</span>.<span class="property">user</span>.<span class="property">is_admin</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;您没有权限进行此操作。&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> contest_id = <span class="built_in">parseInt</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">let</span> contest = <span class="keyword">await</span> <span class="title class_">Contest</span>.<span class="title function_">findById</span>(contest_id);</span><br><span class="line">    <span class="keyword">let</span> ranklist = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (!contest) &#123;</span><br><span class="line">      contest = <span class="keyword">await</span> <span class="title class_">Contest</span>.<span class="title function_">create</span>();</span><br><span class="line"></span><br><span class="line">      contest.<span class="property">holder_id</span> = res.<span class="property">locals</span>.<span class="property">user</span>.<span class="property">id</span>;</span><br><span class="line"></span><br><span class="line">      ranklist = <span class="keyword">await</span> <span class="title class_">ContestRanklist</span>.<span class="title function_">create</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> contest.<span class="title function_">loadRelationships</span>();</span><br><span class="line">      ranklist = contest.<span class="property">ranklist</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (![<span class="string">&#x27;NOI&#x27;</span>, <span class="string">&#x27;IOI&#x27;</span>, <span class="string">&#x27;ACM&#x27;</span>].<span class="title function_">includes</span>(req.<span class="property">body</span>.<span class="property">type</span>)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;无效的赛制。&#x27;</span>);</span><br><span class="line">    contest.<span class="property">type</span> = req.<span class="property">body</span>.<span class="property">type</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      ranklist.<span class="property">ranking_params</span> = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(req.<span class="property">body</span>.<span class="property">ranking_params</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      ranklist.<span class="property">ranking_params</span> = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> ranklist.<span class="title function_">save</span>();</span><br><span class="line">    contest.<span class="property">ranklist_id</span> = ranklist.<span class="property">id</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!req.<span class="property">body</span>.<span class="property">title</span>.<span class="title function_">trim</span>()) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;比赛名不能为空。&#x27;</span>);</span><br><span class="line">    contest.<span class="property">title</span> = req.<span class="property">body</span>.<span class="property">title</span>;</span><br><span class="line">    contest.<span class="property">subtitle</span> = req.<span class="property">body</span>.<span class="property">subtitle</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(req.<span class="property">body</span>.<span class="property">problems</span>)) req.<span class="property">body</span>.<span class="property">problems</span> = [req.<span class="property">body</span>.<span class="property">problems</span>];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(req.<span class="property">body</span>.<span class="property">admins</span>)) req.<span class="property">body</span>.<span class="property">admins</span> = [req.<span class="property">body</span>.<span class="property">admins</span>];</span><br><span class="line">    contest.<span class="property">problems</span> = req.<span class="property">body</span>.<span class="property">problems</span>.<span class="title function_">join</span>(<span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">    contest.<span class="property">admins</span> = req.<span class="property">body</span>.<span class="property">admins</span>.<span class="title function_">join</span>(<span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">    contest.<span class="property">information</span> = req.<span class="property">body</span>.<span class="property">information</span>;</span><br><span class="line">    contest.<span class="property">start_time</span> = syzoj.<span class="property">utils</span>.<span class="title function_">parseDate</span>(req.<span class="property">body</span>.<span class="property">start_time</span>);</span><br><span class="line">    contest.<span class="property">end_time</span> = syzoj.<span class="property">utils</span>.<span class="title function_">parseDate</span>(req.<span class="property">body</span>.<span class="property">end_time</span>);</span><br><span class="line">    contest.<span class="property">is_public</span> = req.<span class="property">body</span>.<span class="property">is_public</span> === <span class="string">&#x27;on&#x27;</span>;</span><br><span class="line">    contest.<span class="property">hide_statistics</span> = req.<span class="property">body</span>.<span class="property">hide_statistics</span> === <span class="string">&#x27;on&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> contest.<span class="title function_">save</span>();</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">redirect</span>(syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;contest&#x27;</span>, contest.<span class="property">id</span>]));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    syzoj.<span class="title function_">log</span>(e);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">err</span>: e</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/contest/:id&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;请登录后继续。&#x27;</span>, &#123; <span class="string">&#x27;登录&#x27;</span>: syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;login&#x27;</span>], &#123; <span class="string">&#x27;url&#x27;</span>: req.<span class="property">originalUrl</span> &#125;) &#125;);</span><br><span class="line">    <span class="keyword">const</span> curUser = res.<span class="property">locals</span>.<span class="property">user</span>;</span><br><span class="line">    <span class="keyword">let</span> contest_id = <span class="built_in">parseInt</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> contest = <span class="keyword">await</span> <span class="title class_">Contest</span>.<span class="title function_">findById</span>(contest_id);</span><br><span class="line">    <span class="keyword">if</span> (!contest) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;无此比赛。&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!contest.<span class="property">is_public</span> &amp;&amp; (!res.<span class="property">locals</span>.<span class="property">user</span> || !res.<span class="property">locals</span>.<span class="property">user</span>.<span class="property">is_admin</span>)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;比赛未公开，请耐心等待 (´∀ `)&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> isSupervisior = <span class="keyword">await</span> contest.<span class="title function_">isSupervisior</span>(curUser);</span><br><span class="line">    contest.<span class="property">running</span> = contest.<span class="title function_">isRunning</span>();</span><br><span class="line">    contest.<span class="property">ended</span> = contest.<span class="title function_">isEnded</span>();</span><br><span class="line">    contest.<span class="property">subtitle</span> = <span class="keyword">await</span> syzoj.<span class="property">utils</span>.<span class="title function_">markdown</span>(contest.<span class="property">subtitle</span>);</span><br><span class="line">    contest.<span class="property">information</span> = <span class="keyword">await</span> syzoj.<span class="property">utils</span>.<span class="title function_">markdown</span>(contest.<span class="property">information</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> hasStatistics = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> ((!contest.<span class="property">hide_statistics</span>) || (contest.<span class="property">ended</span>) || (isSupervisior)) &#123;</span><br><span class="line">      hasStatistics = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;contest&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">contest</span>: contest,</span><br><span class="line">      <span class="attr">hasStatistics</span>: hasStatistics,</span><br><span class="line">      <span class="attr">isSupervisior</span>: isSupervisior</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    syzoj.<span class="title function_">log</span>(e);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">err</span>: e</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/contest/:id/problem&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;请登录后继续。&#x27;</span>, &#123; <span class="string">&#x27;登录&#x27;</span>: syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;login&#x27;</span>], &#123; <span class="string">&#x27;url&#x27;</span>: req.<span class="property">originalUrl</span> &#125;) &#125;);</span><br><span class="line">    <span class="keyword">const</span> curUser = res.<span class="property">locals</span>.<span class="property">user</span>;</span><br><span class="line">    <span class="keyword">let</span> contest_id = <span class="built_in">parseInt</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> contest = <span class="keyword">await</span> <span class="title class_">Contest</span>.<span class="title function_">findById</span>(contest_id);</span><br><span class="line">    <span class="keyword">if</span> (!contest) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;无此比赛。&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!contest.<span class="property">is_public</span> &amp;&amp; (!res.<span class="property">locals</span>.<span class="property">user</span> || !res.<span class="property">locals</span>.<span class="property">user</span>.<span class="property">is_admin</span>)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;比赛未公开，请耐心等待 (´∀ `)&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> isSupervisior = <span class="keyword">await</span> contest.<span class="title function_">isSupervisior</span>(curUser);</span><br><span class="line">    contest.<span class="property">running</span> = contest.<span class="title function_">isRunning</span>();</span><br><span class="line">    contest.<span class="property">ended</span> = contest.<span class="title function_">isEnded</span>();</span><br><span class="line">    contest.<span class="property">subtitle</span> = <span class="keyword">await</span> syzoj.<span class="property">utils</span>.<span class="title function_">markdown</span>(contest.<span class="property">subtitle</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!contest.<span class="property">running</span> &amp;&amp; !contest.<span class="property">ended</span> &amp;&amp; (!res.<span class="property">locals</span>.<span class="property">user</span> || !res.<span class="property">locals</span>.<span class="property">user</span>.<span class="property">is_admin</span>)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;比赛未开始，请耐心等待 (´∀ `)&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> problems_id = <span class="keyword">await</span> contest.<span class="title function_">getProblems</span>();</span><br><span class="line">    <span class="keyword">let</span> problems = <span class="keyword">await</span> problems_id.<span class="title function_">mapAsync</span>(<span class="keyword">async</span> id =&gt; <span class="keyword">await</span> <span class="title class_">Problem</span>.<span class="title function_">findById</span>(id));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> player = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (res.<span class="property">locals</span>.<span class="property">user</span>) &#123;</span><br><span class="line">      player = <span class="keyword">await</span> <span class="title class_">ContestPlayer</span>.<span class="title function_">findInContest</span>(&#123;</span><br><span class="line">        <span class="attr">contest_id</span>: contest.<span class="property">id</span>,</span><br><span class="line">        <span class="attr">user_id</span>: res.<span class="property">locals</span>.<span class="property">user</span>.<span class="property">id</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    problems = problems.<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> (&#123; <span class="attr">problem</span>: x, <span class="attr">status</span>: <span class="literal">null</span>, <span class="attr">judge_id</span>: <span class="literal">null</span>, <span class="attr">statistics</span>: <span class="literal">null</span> &#125;));</span><br><span class="line">    <span class="keyword">if</span> (player) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> problem <span class="keyword">of</span> problems) &#123;</span><br><span class="line">        <span class="keyword">if</span> (contest.<span class="property">type</span> === <span class="string">&#x27;NOI&#x27;</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (player.<span class="property">score_details</span>[problem.<span class="property">problem</span>.<span class="property">id</span>]) &#123;</span><br><span class="line">            <span class="keyword">let</span> judge_state = <span class="keyword">await</span> <span class="title class_">JudgeState</span>.<span class="title function_">findById</span>(player.<span class="property">score_details</span>[problem.<span class="property">problem</span>.<span class="property">id</span>].<span class="property">judge_id</span>);</span><br><span class="line">            problem.<span class="property">status</span> = judge_state.<span class="property">status</span>;</span><br><span class="line">            <span class="keyword">if</span> (!contest.<span class="property">ended</span> &amp;&amp; !<span class="keyword">await</span> problem.<span class="property">problem</span>.<span class="title function_">isAllowedEditBy</span>(res.<span class="property">locals</span>.<span class="property">user</span>) &amp;&amp; ![<span class="string">&#x27;Compile Error&#x27;</span>, <span class="string">&#x27;Waiting&#x27;</span>, <span class="string">&#x27;Compiling&#x27;</span>].<span class="title function_">includes</span>(problem.<span class="property">status</span>)) &#123;</span><br><span class="line">              problem.<span class="property">status</span> = <span class="string">&#x27;Submitted&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            problem.<span class="property">judge_id</span> = player.<span class="property">score_details</span>[problem.<span class="property">problem</span>.<span class="property">id</span>].<span class="property">judge_id</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (contest.<span class="property">type</span> === <span class="string">&#x27;IOI&#x27;</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (player.<span class="property">score_details</span>[problem.<span class="property">problem</span>.<span class="property">id</span>]) &#123;</span><br><span class="line">            <span class="keyword">let</span> judge_state = <span class="keyword">await</span> <span class="title class_">JudgeState</span>.<span class="title function_">findById</span>(player.<span class="property">score_details</span>[problem.<span class="property">problem</span>.<span class="property">id</span>].<span class="property">judge_id</span>);</span><br><span class="line">            problem.<span class="property">status</span> = judge_state.<span class="property">status</span>;</span><br><span class="line">            problem.<span class="property">judge_id</span> = player.<span class="property">score_details</span>[problem.<span class="property">problem</span>.<span class="property">id</span>].<span class="property">judge_id</span>;</span><br><span class="line">            <span class="keyword">await</span> contest.<span class="title function_">loadRelationships</span>();</span><br><span class="line">            <span class="keyword">let</span> multiplier = contest.<span class="property">ranklist</span>.<span class="property">ranking_params</span>[problem.<span class="property">problem</span>.<span class="property">id</span>] || <span class="number">1.0</span>;</span><br><span class="line">            problem.<span class="property">feedback</span> = (judge_state.<span class="property">score</span> * multiplier).<span class="title function_">toString</span>() + <span class="string">&#x27; / &#x27;</span> + (<span class="number">100</span> * multiplier).<span class="title function_">toString</span>();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (contest.<span class="property">type</span> === <span class="string">&#x27;ACM&#x27;</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (player.<span class="property">score_details</span>[problem.<span class="property">problem</span>.<span class="property">id</span>]) &#123;</span><br><span class="line">            problem.<span class="property">status</span> = &#123;</span><br><span class="line">              <span class="attr">accepted</span>: player.<span class="property">score_details</span>[problem.<span class="property">problem</span>.<span class="property">id</span>].<span class="property">accepted</span>,</span><br><span class="line">              <span class="attr">unacceptedCount</span>: player.<span class="property">score_details</span>[problem.<span class="property">problem</span>.<span class="property">id</span>].<span class="property">unacceptedCount</span></span><br><span class="line">            &#125;;</span><br><span class="line">            problem.<span class="property">judge_id</span> = player.<span class="property">score_details</span>[problem.<span class="property">problem</span>.<span class="property">id</span>].<span class="property">judge_id</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            problem.<span class="property">status</span> = <span class="literal">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> hasStatistics = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> ((!contest.<span class="property">hide_statistics</span>) || (contest.<span class="property">ended</span>) || (isSupervisior)) &#123;</span><br><span class="line">      hasStatistics = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">await</span> contest.<span class="title function_">loadRelationships</span>();</span><br><span class="line">      <span class="keyword">let</span> players = <span class="keyword">await</span> contest.<span class="property">ranklist</span>.<span class="title function_">getPlayers</span>();</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> problem <span class="keyword">of</span> problems) &#123;</span><br><span class="line">        problem.<span class="property">statistics</span> = &#123; <span class="attr">attempt</span>: <span class="number">0</span>, <span class="attr">accepted</span>: <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (contest.<span class="property">type</span> === <span class="string">&#x27;IOI&#x27;</span> || contest.<span class="property">type</span> === <span class="string">&#x27;NOI&#x27;</span>) &#123;</span><br><span class="line">          problem.<span class="property">statistics</span>.<span class="property">partially</span> = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> player <span class="keyword">of</span> players) &#123;</span><br><span class="line">          <span class="keyword">if</span> (player.<span class="property">score_details</span>[problem.<span class="property">problem</span>.<span class="property">id</span>]) &#123;</span><br><span class="line">            problem.<span class="property">statistics</span>.<span class="property">attempt</span>++;</span><br><span class="line">            <span class="keyword">if</span> ((contest.<span class="property">type</span> === <span class="string">&#x27;ACM&#x27;</span> &amp;&amp; player.<span class="property">score_details</span>[problem.<span class="property">problem</span>.<span class="property">id</span>].<span class="property">accepted</span>) || ((contest.<span class="property">type</span> === <span class="string">&#x27;NOI&#x27;</span> || contest.<span class="property">type</span> === <span class="string">&#x27;IOI&#x27;</span>) &amp;&amp; player.<span class="property">score_details</span>[problem.<span class="property">problem</span>.<span class="property">id</span>].<span class="property">score</span> === <span class="number">100</span>)) &#123;</span><br><span class="line">              problem.<span class="property">statistics</span>.<span class="property">accepted</span>++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((contest.<span class="property">type</span> === <span class="string">&#x27;NOI&#x27;</span> || contest.<span class="property">type</span> === <span class="string">&#x27;IOI&#x27;</span>) &amp;&amp; player.<span class="property">score_details</span>[problem.<span class="property">problem</span>.<span class="property">id</span>].<span class="property">score</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              problem.<span class="property">statistics</span>.<span class="property">partially</span>++;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;contest_problem&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">contest</span>: contest,</span><br><span class="line">      <span class="attr">problems</span>: problems,</span><br><span class="line">      <span class="attr">hasStatistics</span>: hasStatistics,</span><br><span class="line">      <span class="attr">isSupervisior</span>: isSupervisior</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    syzoj.<span class="title function_">log</span>(e);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">err</span>: e</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/contest/:id/ranklist&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;请登录后继续。&#x27;</span>, &#123; <span class="string">&#x27;登录&#x27;</span>: syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;login&#x27;</span>], &#123; <span class="string">&#x27;url&#x27;</span>: req.<span class="property">originalUrl</span> &#125;) &#125;);</span><br><span class="line">    <span class="keyword">let</span> contest_id = <span class="built_in">parseInt</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">let</span> contest = <span class="keyword">await</span> <span class="title class_">Contest</span>.<span class="title function_">findById</span>(contest_id);</span><br><span class="line">    <span class="keyword">const</span> curUser = res.<span class="property">locals</span>.<span class="property">user</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!contest) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;无此比赛。&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!contest.<span class="property">is_public</span> &amp;&amp; (!res.<span class="property">locals</span>.<span class="property">user</span> || !res.<span class="property">locals</span>.<span class="property">user</span>.<span class="property">is_admin</span>)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;比赛未公开，请耐心等待 (´∀ `)&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ([contest.<span class="title function_">allowedSeeingResult</span>() &amp;&amp; contest.<span class="title function_">allowedSeeingOthers</span>(),</span><br><span class="line">    contest.<span class="title function_">isEnded</span>(),</span><br><span class="line">    <span class="keyword">await</span> contest.<span class="title function_">isSupervisior</span>(curUser)].<span class="title function_">every</span>(<span class="function"><span class="params">x</span> =&gt;</span> !x))</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;您没有权限进行此操作。&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> isSupervisior = <span class="keyword">await</span> contest.<span class="title function_">isSupervisior</span>(curUser);</span><br><span class="line">    contest.<span class="property">ended</span> = contest.<span class="title function_">isEnded</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> contest.<span class="title function_">loadRelationships</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> players_id = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt;= contest.<span class="property">ranklist</span>.<span class="property">ranklist</span>.<span class="property">player_num</span>; i++) players_id.<span class="title function_">push</span>(contest.<span class="property">ranklist</span>.<span class="property">ranklist</span>[i]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> ranklist = <span class="keyword">await</span> players_id.<span class="title function_">mapAsync</span>(<span class="keyword">async</span> player_id =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> player = <span class="keyword">await</span> <span class="title class_">ContestPlayer</span>.<span class="title function_">findById</span>(player_id);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (contest.<span class="property">type</span> === <span class="string">&#x27;NOI&#x27;</span> || contest.<span class="property">type</span> === <span class="string">&#x27;IOI&#x27;</span>) &#123;</span><br><span class="line">        player.<span class="property">score</span> = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> player.<span class="property">score_details</span>) &#123;</span><br><span class="line">        player.<span class="property">score_details</span>[i].<span class="property">judge_state</span> = <span class="keyword">await</span> <span class="title class_">JudgeState</span>.<span class="title function_">findById</span>(player.<span class="property">score_details</span>[i].<span class="property">judge_id</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*** <span class="doctag">XXX:</span> Clumsy duplication, see ContestRanklist::updatePlayer() ***/</span></span><br><span class="line">        <span class="keyword">if</span> (contest.<span class="property">type</span> === <span class="string">&#x27;NOI&#x27;</span> || contest.<span class="property">type</span> === <span class="string">&#x27;IOI&#x27;</span>) &#123;</span><br><span class="line">          <span class="keyword">let</span> multiplier = (contest.<span class="property">ranklist</span>.<span class="property">ranking_params</span> || &#123;&#125;)[i] || <span class="number">1.0</span>;</span><br><span class="line">          player.<span class="property">score_details</span>[i].<span class="property">weighted_score</span> = player.<span class="property">score_details</span>[i].<span class="property">score</span> == <span class="literal">null</span> ? <span class="literal">null</span> : <span class="title class_">Math</span>.<span class="title function_">round</span>(player.<span class="property">score_details</span>[i].<span class="property">score</span> * multiplier);</span><br><span class="line">          player.<span class="property">score</span> += player.<span class="property">score_details</span>[i].<span class="property">weighted_score</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> user = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findById</span>(player.<span class="property">user_id</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">user</span>: user,</span><br><span class="line">        <span class="attr">player</span>: player</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> problems_id = <span class="keyword">await</span> contest.<span class="title function_">getProblems</span>();</span><br><span class="line">    <span class="keyword">let</span> problems = <span class="keyword">await</span> problems_id.<span class="title function_">mapAsync</span>(<span class="keyword">async</span> id =&gt; <span class="keyword">await</span> <span class="title class_">Problem</span>.<span class="title function_">findById</span>(id));</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;contest_ranklist&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">contest</span>: contest,</span><br><span class="line">      <span class="attr">ranklist</span>: ranklist,</span><br><span class="line">      <span class="attr">problems</span>: problems,</span><br><span class="line">      <span class="attr">isSupervisior</span>: isSupervisior</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    syzoj.<span class="title function_">log</span>(e);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">err</span>: e</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getDisplayConfig</span>(<span class="params">contest</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">showScore</span>: contest.<span class="title function_">allowedSeeingScore</span>(),</span><br><span class="line">    <span class="attr">showUsage</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">showCode</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">showResult</span>: contest.<span class="title function_">allowedSeeingResult</span>(),</span><br><span class="line">    <span class="attr">showOthers</span>: contest.<span class="title function_">allowedSeeingOthers</span>(),</span><br><span class="line">    <span class="attr">showDetailResult</span>: contest.<span class="title function_">allowedSeeingTestcase</span>(),</span><br><span class="line">    <span class="attr">showTestdata</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">inContest</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">showRejudge</span>: <span class="literal">false</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/contest/:id/submissions&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;请登录后继续。&#x27;</span>, &#123; <span class="string">&#x27;登录&#x27;</span>: syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;login&#x27;</span>], &#123; <span class="string">&#x27;url&#x27;</span>: req.<span class="property">originalUrl</span> &#125;) &#125;);</span><br><span class="line">    <span class="keyword">let</span> contest_id = <span class="built_in">parseInt</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">let</span> contest = <span class="keyword">await</span> <span class="title class_">Contest</span>.<span class="title function_">findById</span>(contest_id);</span><br><span class="line">    <span class="keyword">if</span> (!contest.<span class="property">is_public</span> &amp;&amp; (!res.<span class="property">locals</span>.<span class="property">user</span> || !res.<span class="property">locals</span>.<span class="property">user</span>.<span class="property">is_admin</span>)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;比赛未公开，请耐心等待 (´∀ `)&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> displayConfig = <span class="title function_">getDisplayConfig</span>(contest);</span><br><span class="line">    <span class="keyword">let</span> problems_id = <span class="keyword">await</span> contest.<span class="title function_">getProblems</span>();</span><br><span class="line">    <span class="keyword">const</span> curUser = res.<span class="property">locals</span>.<span class="property">user</span>;</span><br><span class="line">    <span class="keyword">const</span> isSupervisior = <span class="keyword">await</span> contest.<span class="title function_">isSupervisior</span>(curUser);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (contest.<span class="title function_">isEnded</span>() || (curUser &amp;&amp; <span class="keyword">await</span> contest.<span class="title function_">isSupervisior</span>(curUser))) &#123;</span><br><span class="line">      res.<span class="title function_">redirect</span>(syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;submissions&#x27;</span>], &#123; <span class="attr">contest</span>: contest_id &#125;));</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> user = req.<span class="property">query</span>.<span class="property">submitter</span> &amp;&amp; <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">fromName</span>(req.<span class="property">query</span>.<span class="property">submitter</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> query = <span class="title class_">JudgeState</span>.<span class="title function_">createQueryBuilder</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> isFiltered = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (displayConfig.<span class="property">showOthers</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (user) &#123;</span><br><span class="line">        query.<span class="title function_">andWhere</span>(<span class="string">&#x27;user_id = :user_id&#x27;</span>, &#123; <span class="attr">user_id</span>: user.<span class="property">id</span> &#125;);</span><br><span class="line">        isFiltered = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (curUser == <span class="literal">null</span> || <span class="comment">// Not logined</span></span><br><span class="line">        (user &amp;&amp; user.<span class="property">id</span> !== curUser.<span class="property">id</span>)) &#123; <span class="comment">// Not querying himself</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&quot;您没有权限执行此操作。&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      query.<span class="title function_">andWhere</span>(<span class="string">&#x27;user_id = :user_id&#x27;</span>, &#123; <span class="attr">user_id</span>: curUser.<span class="property">id</span> &#125;);</span><br><span class="line">      isFiltered = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (displayConfig.<span class="property">showScore</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> minScore = <span class="built_in">parseInt</span>(req.<span class="property">body</span>.<span class="property">min_score</span>);</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">isNaN</span>(minScore)) query.<span class="title function_">andWhere</span>(<span class="string">&#x27;score &gt;= :minScore&#x27;</span>, &#123; minScore &#125;);</span><br><span class="line">      <span class="keyword">let</span> maxScore = <span class="built_in">parseInt</span>(req.<span class="property">body</span>.<span class="property">max_score</span>);</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">isNaN</span>(maxScore)) query.<span class="title function_">andWhere</span>(<span class="string">&#x27;score &lt;= :maxScore&#x27;</span>, &#123; maxScore &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">isNaN</span>(minScore) || !<span class="built_in">isNaN</span>(maxScore)) isFiltered = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">query</span>.<span class="property">language</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (req.<span class="property">body</span>.<span class="property">language</span> === <span class="string">&#x27;submit-answer&#x27;</span>) &#123;</span><br><span class="line">        query.<span class="title function_">andWhere</span>(<span class="keyword">new</span> <span class="title class_">TypeORM</span>.<span class="title class_">Brackets</span>(<span class="function"><span class="params">qb</span> =&gt;</span> &#123;</span><br><span class="line">          qb.<span class="title function_">orWhere</span>(<span class="string">&#x27;language = :language&#x27;</span>, &#123; <span class="attr">language</span>: <span class="string">&#x27;&#x27;</span> &#125;)</span><br><span class="line">            .<span class="title function_">orWhere</span>(<span class="string">&#x27;language IS NULL&#x27;</span>);</span><br><span class="line">        &#125;));</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req.<span class="property">body</span>.<span class="property">language</span> === <span class="string">&#x27;non-submit-answer&#x27;</span>) &#123;</span><br><span class="line">        query.<span class="title function_">andWhere</span>(<span class="string">&#x27;language != :language&#x27;</span>, &#123; <span class="attr">language</span>: <span class="string">&#x27;&#x27;</span> &#125;)</span><br><span class="line">             .<span class="title function_">andWhere</span>(<span class="string">&#x27;language IS NOT NULL&#x27;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        query.<span class="title function_">andWhere</span>(<span class="string">&#x27;language = :language&#x27;</span>, &#123; <span class="attr">language</span>: req.<span class="property">body</span>.<span class="property">language</span> &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      isFiltered = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (displayConfig.<span class="property">showResult</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (req.<span class="property">query</span>.<span class="property">status</span>) &#123;</span><br><span class="line">        query.<span class="title function_">andWhere</span>(<span class="string">&#x27;status = :status&#x27;</span>, &#123; <span class="attr">status</span>: req.<span class="property">query</span>.<span class="property">status</span> &#125;);</span><br><span class="line">        isFiltered = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">query</span>.<span class="property">problem_id</span>) &#123;</span><br><span class="line">      problem_id = problems_id[<span class="built_in">parseInt</span>(req.<span class="property">query</span>.<span class="property">problem_id</span>) - <span class="number">1</span>] || <span class="number">0</span>;</span><br><span class="line">      query.<span class="title function_">andWhere</span>(<span class="string">&#x27;problem_id = :problem_id&#x27;</span>, &#123; problem_id &#125;)</span><br><span class="line">      isFiltered = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    query.<span class="title function_">andWhere</span>(<span class="string">&#x27;type = 1&#x27;</span>)</span><br><span class="line">         .<span class="title function_">andWhere</span>(<span class="string">&#x27;type_info = :contest_id&#x27;</span>, &#123; contest_id &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> judge_state, paginate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (syzoj.<span class="property">config</span>.<span class="property">submissions_page_fast_pagination</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> queryResult = <span class="keyword">await</span> <span class="title class_">JudgeState</span>.<span class="title function_">queryPageFast</span>(query, syzoj.<span class="property">utils</span>.<span class="title function_">paginateFast</span>(</span><br><span class="line">        req.<span class="property">query</span>.<span class="property">currPageTop</span>, req.<span class="property">query</span>.<span class="property">currPageBottom</span>, syzoj.<span class="property">config</span>.<span class="property">page</span>.<span class="property">judge_state</span></span><br><span class="line">      ), -<span class="number">1</span>, <span class="built_in">parseInt</span>(req.<span class="property">query</span>.<span class="property">page</span>));</span><br><span class="line"></span><br><span class="line">      judge_state = queryResult.<span class="property">data</span>;</span><br><span class="line">      paginate = queryResult.<span class="property">meta</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      paginate = syzoj.<span class="property">utils</span>.<span class="title function_">paginate</span>(</span><br><span class="line">        <span class="keyword">await</span> <span class="title class_">JudgeState</span>.<span class="title function_">countQuery</span>(query),</span><br><span class="line">        req.<span class="property">query</span>.<span class="property">page</span>,</span><br><span class="line">        syzoj.<span class="property">config</span>.<span class="property">page</span>.<span class="property">judge_state</span></span><br><span class="line">      );</span><br><span class="line">      judge_state = <span class="keyword">await</span> <span class="title class_">JudgeState</span>.<span class="title function_">queryPage</span>(paginate, query, &#123; <span class="attr">id</span>: <span class="string">&quot;DESC&quot;</span> &#125;, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> judge_state.<span class="title function_">forEachAsync</span>(<span class="keyword">async</span> obj =&gt; &#123;</span><br><span class="line">      <span class="keyword">await</span> obj.<span class="title function_">loadRelationships</span>();</span><br><span class="line">      obj.<span class="property">problem_id</span> = problems_id.<span class="title function_">indexOf</span>(obj.<span class="property">problem_id</span>) + <span class="number">1</span>;</span><br><span class="line">      obj.<span class="property">problem</span>.<span class="property">title</span> = syzoj.<span class="property">utils</span>.<span class="title function_">removeTitleTag</span>(obj.<span class="property">problem</span>.<span class="property">title</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> pushType = displayConfig.<span class="property">showResult</span> ? <span class="string">&#x27;rough&#x27;</span> : <span class="string">&#x27;compile&#x27;</span>;</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;submissions&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">contest</span>: contest,</span><br><span class="line">      <span class="attr">isSupervisior</span>: isSupervisior,</span><br><span class="line">      <span class="attr">items</span>: judge_state.<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">info</span>: <span class="title function_">getSubmissionInfo</span>(x, displayConfig),</span><br><span class="line">        <span class="attr">token</span>: (<span class="title function_">getRoughResult</span>(x, displayConfig) == <span class="literal">null</span> &amp;&amp; x.<span class="property">task_id</span> != <span class="literal">null</span>) ? jwt.<span class="title function_">sign</span>(&#123;</span><br><span class="line">          <span class="attr">taskId</span>: x.<span class="property">task_id</span>,</span><br><span class="line">          <span class="attr">type</span>: pushType,</span><br><span class="line">          <span class="attr">displayConfig</span>: displayConfig</span><br><span class="line">        &#125;, syzoj.<span class="property">config</span>.<span class="property">session_secret</span>) : <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="title function_">getRoughResult</span>(x, displayConfig),</span><br><span class="line">        <span class="attr">running</span>: <span class="literal">false</span>,</span><br><span class="line">      &#125;)),</span><br><span class="line">      <span class="attr">paginate</span>: paginate,</span><br><span class="line">      <span class="attr">form</span>: req.<span class="property">query</span>,</span><br><span class="line">      <span class="attr">displayConfig</span>: displayConfig,</span><br><span class="line">      <span class="attr">pushType</span>: pushType,</span><br><span class="line">      <span class="attr">isFiltered</span>: isFiltered,</span><br><span class="line">      <span class="attr">fast_pagination</span>: syzoj.<span class="property">config</span>.<span class="property">submissions_page_fast_pagination</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    syzoj.<span class="title function_">log</span>(e);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">err</span>: e</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/contest/submission/:id&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;请登录后继续。&#x27;</span>, &#123; <span class="string">&#x27;登录&#x27;</span>: syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;login&#x27;</span>], &#123; <span class="string">&#x27;url&#x27;</span>: req.<span class="property">originalUrl</span> &#125;) &#125;);</span><br><span class="line">    <span class="keyword">const</span> id = <span class="built_in">parseInt</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">const</span> judge = <span class="keyword">await</span> <span class="title class_">JudgeState</span>.<span class="title function_">findById</span>(id);</span><br><span class="line">    <span class="keyword">if</span> (!judge) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&quot;提交记录 ID 不正确。&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> curUser = res.<span class="property">locals</span>.<span class="property">user</span>;</span><br><span class="line">    <span class="keyword">if</span> ((!curUser) || judge.<span class="property">user_id</span> !== curUser.<span class="property">id</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&quot;您没有权限执行此操作。&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (judge.<span class="property">type</span> !== <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">redirect</span>(syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;submission&#x27;</span>, id]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> contest = <span class="keyword">await</span> <span class="title class_">Contest</span>.<span class="title function_">findById</span>(judge.<span class="property">type_info</span>);</span><br><span class="line">    contest.<span class="property">ended</span> = contest.<span class="title function_">isEnded</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> displayConfig = <span class="title function_">getDisplayConfig</span>(contest);</span><br><span class="line">    displayConfig.<span class="property">showCode</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> judge.<span class="title function_">loadRelationships</span>();</span><br><span class="line">    <span class="keyword">const</span> problems_id = <span class="keyword">await</span> contest.<span class="title function_">getProblems</span>();</span><br><span class="line">    judge.<span class="property">problem_id</span> = problems_id.<span class="title function_">indexOf</span>(judge.<span class="property">problem_id</span>) + <span class="number">1</span>;</span><br><span class="line">    judge.<span class="property">problem</span>.<span class="property">title</span> = syzoj.<span class="property">utils</span>.<span class="title function_">removeTitleTag</span>(judge.<span class="property">problem</span>.<span class="property">title</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (judge.<span class="property">problem</span>.<span class="property">type</span> !== <span class="string">&#x27;submit-answer&#x27;</span>) &#123;</span><br><span class="line">      judge.<span class="property">codeLength</span> = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(judge.<span class="property">code</span>).<span class="property">length</span>;</span><br><span class="line">      judge.<span class="property">code</span> = <span class="keyword">await</span> syzoj.<span class="property">utils</span>.<span class="title function_">highlight</span>(judge.<span class="property">code</span>, syzoj.<span class="property">languages</span>[judge.<span class="property">language</span>].<span class="property">highlight</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;submission&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">info</span>: <span class="title function_">getSubmissionInfo</span>(judge, displayConfig),</span><br><span class="line">      <span class="attr">roughResult</span>: <span class="title function_">getRoughResult</span>(judge, displayConfig),</span><br><span class="line">      <span class="attr">code</span>: (displayConfig.<span class="property">showCode</span> &amp;&amp; judge.<span class="property">problem</span>.<span class="property">type</span> !== <span class="string">&#x27;submit-answer&#x27;</span>) ? judge.<span class="property">code</span>.<span class="title function_">toString</span>(<span class="string">&quot;utf8&quot;</span>) : <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      <span class="attr">formattedCode</span>: judge.<span class="property">formattedCode</span> ? judge.<span class="property">formattedCode</span>.<span class="title function_">toString</span>(<span class="string">&quot;utf8&quot;</span>) : <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">preferFormattedCode</span>: res.<span class="property">locals</span>.<span class="property">user</span> ? res.<span class="property">locals</span>.<span class="property">user</span>.<span class="property">prefer_formatted_code</span> : <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">detailResult</span>: <span class="title function_">processOverallResult</span>(judge.<span class="property">result</span>, displayConfig),</span><br><span class="line">      <span class="attr">socketToken</span>: (displayConfig.<span class="property">showDetailResult</span> &amp;&amp; judge.<span class="property">pending</span> &amp;&amp; judge.<span class="property">task_id</span> != <span class="literal">null</span>) ? jwt.<span class="title function_">sign</span>(&#123;</span><br><span class="line">        <span class="attr">taskId</span>: judge.<span class="property">task_id</span>,</span><br><span class="line">        <span class="attr">displayConfig</span>: displayConfig,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;detail&#x27;</span></span><br><span class="line">      &#125;, syzoj.<span class="property">config</span>.<span class="property">session_secret</span>) : <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">displayConfig</span>: displayConfig,</span><br><span class="line">      <span class="attr">contest</span>: contest,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    syzoj.<span class="title function_">log</span>(e);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">err</span>: e</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/contest/:id/problem/:pid&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;请登录后继续。&#x27;</span>, &#123; <span class="string">&#x27;登录&#x27;</span>: syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;login&#x27;</span>], &#123; <span class="string">&#x27;url&#x27;</span>: req.<span class="property">originalUrl</span> &#125;) &#125;);</span><br><span class="line">    <span class="keyword">let</span> contest_id = <span class="built_in">parseInt</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">let</span> contest = <span class="keyword">await</span> <span class="title class_">Contest</span>.<span class="title function_">findById</span>(contest_id);</span><br><span class="line">    <span class="keyword">if</span> (!contest) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;无此比赛。&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> curUser = res.<span class="property">locals</span>.<span class="property">user</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> problems_id = <span class="keyword">await</span> contest.<span class="title function_">getProblems</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> pid = <span class="built_in">parseInt</span>(req.<span class="property">params</span>.<span class="property">pid</span>);</span><br><span class="line">    <span class="keyword">if</span> (!pid || pid &lt; <span class="number">1</span> || pid &gt; problems_id.<span class="property">length</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;无此题目。&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> problem_id = problems_id[pid - <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">let</span> problem = <span class="keyword">await</span> <span class="title class_">Problem</span>.<span class="title function_">findById</span>(problem_id);</span><br><span class="line">    <span class="keyword">await</span> problem.<span class="title function_">loadRelationships</span>();</span><br><span class="line"></span><br><span class="line">    contest.<span class="property">ended</span> = contest.<span class="title function_">isEnded</span>();</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">await</span> contest.<span class="title function_">isSupervisior</span>(curUser) &amp;&amp; !(contest.<span class="title function_">isRunning</span>() || contest.<span class="title function_">isEnded</span>())) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">await</span> problem.<span class="title function_">isAllowedUseBy</span>(res.<span class="property">locals</span>.<span class="property">user</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">redirect</span>(syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;problem&#x27;</span>, problem_id]));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;比赛尚未开始。&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    problem.<span class="property">specialJudge</span> = <span class="keyword">await</span> problem.<span class="title function_">hasSpecialJudge</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> syzoj.<span class="property">utils</span>.<span class="title function_">markdown</span>(problem, [<span class="string">&#x27;description&#x27;</span>, <span class="string">&#x27;input_format&#x27;</span>, <span class="string">&#x27;output_format&#x27;</span>, <span class="string">&#x27;example&#x27;</span>, <span class="string">&#x27;limit_and_hint&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> state = <span class="keyword">await</span> problem.<span class="title function_">getJudgeState</span>(res.<span class="property">locals</span>.<span class="property">user</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">let</span> testcases = <span class="keyword">await</span> syzoj.<span class="property">utils</span>.<span class="title function_">parseTestdata</span>(problem.<span class="title function_">getTestdataPath</span>(), problem.<span class="property">type</span> === <span class="string">&#x27;submit-answer&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> problem.<span class="title function_">loadRelationships</span>();</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;problem&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">pid</span>: pid,</span><br><span class="line">      <span class="attr">contest</span>: contest,</span><br><span class="line">      <span class="attr">problem</span>: problem,</span><br><span class="line">      <span class="attr">state</span>: state,</span><br><span class="line">      <span class="attr">lastLanguage</span>: res.<span class="property">locals</span>.<span class="property">user</span> ? <span class="keyword">await</span> res.<span class="property">locals</span>.<span class="property">user</span>.<span class="title function_">getLastSubmitLanguage</span>() : <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">testcases</span>: testcases</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    syzoj.<span class="title function_">log</span>(e);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">err</span>: e</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/contest/:id/:pid/download/additional_file&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;请登录后继续。&#x27;</span>, &#123; <span class="string">&#x27;登录&#x27;</span>: syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;login&#x27;</span>], &#123; <span class="string">&#x27;url&#x27;</span>: req.<span class="property">originalUrl</span> &#125;) &#125;);</span><br><span class="line">    <span class="keyword">let</span> id = <span class="built_in">parseInt</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">let</span> contest = <span class="keyword">await</span> <span class="title class_">Contest</span>.<span class="title function_">findById</span>(id);</span><br><span class="line">    <span class="keyword">if</span> (!contest) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;无此比赛。&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> problems_id = <span class="keyword">await</span> contest.<span class="title function_">getProblems</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> pid = <span class="built_in">parseInt</span>(req.<span class="property">params</span>.<span class="property">pid</span>);</span><br><span class="line">    <span class="keyword">if</span> (!pid || pid &lt; <span class="number">1</span> || pid &gt; problems_id.<span class="property">length</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;无此题目。&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> problem_id = problems_id[pid - <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">let</span> problem = <span class="keyword">await</span> <span class="title class_">Problem</span>.<span class="title function_">findById</span>(problem_id);</span><br><span class="line"></span><br><span class="line">    contest.<span class="property">ended</span> = contest.<span class="title function_">isEnded</span>();</span><br><span class="line">    <span class="keyword">if</span> (!(contest.<span class="title function_">isRunning</span>() || contest.<span class="title function_">isEnded</span>())) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">await</span> problem.<span class="title function_">isAllowedUseBy</span>(res.<span class="property">locals</span>.<span class="property">user</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">redirect</span>(syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;problem&#x27;</span>, problem_id, <span class="string">&#x27;download&#x27;</span>, <span class="string">&#x27;additional_file&#x27;</span>]));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;比赛尚未开始。&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> problem.<span class="title function_">loadRelationships</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!problem.<span class="property">additional_file</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;无附加文件。&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">download</span>(problem.<span class="property">additional_file</span>.<span class="title function_">getPath</span>(), <span class="string">`additional_file_<span class="subst">$&#123;id&#125;</span>_<span class="subst">$&#123;pid&#125;</span>.zip`</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    syzoj.<span class="title function_">log</span>(e);</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">404</span>);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">err</span>: e</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>views/contests.ejs：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&lt;% this.title = &#x27;比赛&#x27; %&gt;</span><br><span class="line">&lt;% include header %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;padding&quot;</span>&gt;</span></span><br><span class="line">    &lt;% if (contests.length) &#123; %&gt;</span><br><span class="line">    &lt;% if (user &amp;&amp; user.is_admin) &#123; %&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">&quot;ui mini form&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inline fields&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-bottom: 25px; white-space: nowrap; &quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;contest&#x27;, 0, &#x27;edit&#x27;]) %&gt;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ui mini labeled icon right floated button&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-left: auto; &quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ui icon write&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">          添加比赛</span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    &lt;% &#125; %&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;ui very basic center aligned table&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;float:left; margin-left: 20px;&quot;</span>&gt;</span>比赛名称<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">th</span> <span class="attr">style</span>=<span class="string">&quot;width: 170px;&quot;</span>&gt;</span>开始时间<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">th</span> <span class="attr">style</span>=<span class="string">&quot;width: 170px;&quot;</span>&gt;</span>结束时间<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">th</span>&gt;</span>描述<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">th</span> <span class="attr">style</span>=<span class="string">&quot;width: 75px;&quot;</span>&gt;</span>赛制<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">        &lt;%</span><br><span class="line">        for (let contest of contests) &#123;</span><br><span class="line">          let now = syzoj.utils.getCurrentDate();</span><br><span class="line">          let tag = &#x27;&#x27;;</span><br><span class="line">        %&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">          &lt;% if (now &lt; contest.start_time) &#123; %&gt;</span><br><span class="line">            &lt;% tag = &#x27;<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;ui header&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui mini red label&quot;</span>&gt;</span>未开始<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>&#x27; %&gt;</span><br><span class="line">          &lt;% &#125; else if (now &gt;= contest.start_time &amp;&amp; now &lt; contest.end_time) &#123; %&gt;</span><br><span class="line">            &lt;% tag = &#x27;<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;ui header&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui mini green label&quot;</span>&gt;</span>进行中<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>&#x27; %&gt;</span><br><span class="line">          &lt;% &#125; else &#123; %&gt;</span><br><span class="line">            &lt;% tag = &#x27;<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;ui header&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui mini grey label&quot;</span>&gt;</span>已结束<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>&#x27; %&gt;</span><br><span class="line">          &lt;% &#125; %&gt;</span><br><span class="line">          &lt;% if (!contest.is_public) &#123; %&gt;</span><br><span class="line">            &lt;% tag += &#x27;<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;ui header&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui tiny red label&quot;</span>&gt;</span>未公开<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>&#x27; %&gt;</span><br><span class="line">          &lt;% &#125; %&gt;</span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">style</span>=<span class="string">&quot;float:left; margin-left: 20px;&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;contest&#x27;, contest.id]) %&gt;&quot;</span>&gt;</span>&lt;%= contest.title %&gt; &lt;%- tag %&gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span>&gt;</span>&lt;%= syzoj.utils.formatDate(contest.start_time) %&gt;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span>&gt;</span>&lt;%= syzoj.utils.formatDate(contest.end_time) %&gt;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;font-content&quot;</span>&gt;</span>&lt;%- contest.subtitle %&gt;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span>&gt;</span>&lt;%= contest.type %&gt;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        &lt;% &#125; %&gt;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    &lt;% &#125; else &#123; %&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui placeholder segment&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui icon header&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;calendar icon&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-bottom: 20px; &quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        暂无比赛</span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      &lt;% if (user &amp;&amp; user.is_admin) &#123; %&gt;</span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;contest&#x27;, 0, &#x27;edit&#x27;]) %&gt;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ui primary labeled icon button&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ui icon write&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        添加第一场比赛</span><br><span class="line">      <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      &lt;% &#125; %&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    &lt;% &#125; %&gt;</span><br><span class="line">  <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">  &lt;% include page %&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&lt;% include footer %&gt;</span><br></pre></td></tr></table></figure>
<p>views/contest_edit.ejs：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">&lt;% this.title = contest.id ? &#x27;编辑比赛&#x27; : &#x27;新建比赛&#x27; %&gt;</span><br><span class="line">&lt;% include header %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;padding&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;contest&#x27;, contest.id, &#x27;edit&#x27;]) %&gt;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui form&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span>&gt;</span>比赛名称<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&lt;%= contest.title %&gt;&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span>&gt;</span>比赛描述<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;subtitle&quot;</span> <span class="attr">class</span>=<span class="string">&quot;markdown-edit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&lt;%= contest.subtitle %&gt;&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span>&gt;</span>试题列表<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">select</span> <span class="attr">class</span>=<span class="string">&quot;ui fluid search dropdown&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;search_problems&quot;</span> <span class="attr">name</span>=<span class="string">&quot;problems&quot;</span>&gt;</span></span><br><span class="line">                &lt;% for (let problem of problems) &#123; %&gt;</span><br><span class="line">                <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;&lt;%= problem.id %&gt;&quot;</span> <span class="attr">selected</span>&gt;</span>#&lt;%= problem.id %&gt;. &lt;%= problem.title %&gt;<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                &lt;% &#125; %&gt;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span>&gt;</span>比赛管理员<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">select</span> <span class="attr">class</span>=<span class="string">&quot;ui fluid search dropdown&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;search_admins&quot;</span> <span class="attr">name</span>=<span class="string">&quot;admins&quot;</span>&gt;</span></span><br><span class="line">                &lt;% for (let admin of admins) &#123; %&gt;</span><br><span class="line">                <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;&lt;%= admin.id %&gt;&quot;</span> <span class="attr">selected</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-name user-&lt;%= syzoj.utils.makeUserColor(admin.rating, admin.is_admin) %&gt;&quot;</span>&gt;</span>&lt;%= admin.username %&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-gray&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-nameplate&quot;</span>&gt;</span>&lt;%= admin.nameplate %&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                &lt;% &#125; %&gt;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inline fields&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">label</span>&gt;</span>赛制<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui radio checkbox&quot;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;type&quot;</span> <span class="attr">id</span>=<span class="string">&quot;type-NOI&quot;</span> <span class="attr">value</span>=<span class="string">&quot;NOI&quot;</span>&lt;% <span class="attr">if</span> (<span class="attr">contest.type</span> === <span class="string">&#x27;NOI&#x27;</span>) &#123; %&gt;</span> checked=&quot;checked&quot;&lt;% &#125; %&gt;&gt;</span><br><span class="line">                  <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;type-NOI&quot;</span>&gt;</span>NOI<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui radio checkbox&quot;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;type&quot;</span> <span class="attr">id</span>=<span class="string">&quot;type-IOI&quot;</span> <span class="attr">value</span>=<span class="string">&quot;IOI&quot;</span>&lt;% <span class="attr">if</span> (<span class="attr">contest.type</span> === <span class="string">&#x27;IOI&#x27;</span>) &#123; %&gt;</span> checked=&quot;checked&quot;&lt;% &#125; %&gt;&gt;</span><br><span class="line">                  <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;type-IOI&quot;</span>&gt;</span>IOI<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui radio checkbox&quot;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;radio&quot;</span> <span class="attr">name</span>=<span class="string">&quot;type&quot;</span> <span class="attr">id</span>=<span class="string">&quot;type-ACM&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ACM&quot;</span>&lt;% <span class="attr">if</span> (<span class="attr">contest.type</span> === <span class="string">&#x27;ACM&#x27;</span>) &#123; %&gt;</span> checked=&quot;checked&quot;&lt;% &#125; %&gt;&gt;</span><br><span class="line">                  <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;type-ACM&quot;</span>&gt;</span>ICPC<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span>&gt;</span>排行参数（格式：<span class="tag">&lt;<span class="name">code</span>&gt;</span>&#123; &quot;题目 ID&quot;: 分值倍数 &#125;<span class="tag">&lt;/<span class="name">code</span>&gt;</span>）<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;ranking_params&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&lt;%= contest.ranklist ? JSON.stringify(contest.ranklist.ranking_params) : &#x27;&#x27; %&gt;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span>&gt;</span>比赛公告<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">rows</span>=<span class="string">&quot;5&quot;</span> <span class="attr">name</span>=<span class="string">&quot;information&quot;</span> <span class="attr">class</span>=<span class="string">&quot;markdown-edit&quot;</span>&gt;</span>&lt;%= contest.information %&gt;<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span>&gt;</span>开始时间<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;start_time&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&lt;%= syzoj.utils.formatDate(contest.start_time || syzoj.utils.getCurrentDate()) %&gt;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span>&gt;</span>结束时间<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;end_time&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&lt;%= syzoj.utils.formatDate(contest.end_time || syzoj.utils.getCurrentDate()) %&gt;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inline field&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;ui header&quot;</span>&gt;</span>公开<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui toggle checkbox&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span>&lt;% <span class="attr">if</span> (<span class="attr">contest.is_public</span>) &#123; %&gt;</span> checked&lt;% &#125; %&gt; name=&quot;is_public&quot;&gt;</span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;visibility: hidden; &quot;</span>&gt;</span>　<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inline field&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;ui header&quot;</span>&gt;</span>隐藏统计信息<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui toggle checkbox&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span>&lt;% <span class="attr">if</span> (<span class="attr">contest.hide_statistics</span>) &#123; %&gt;</span> checked&lt;% &#125; %&gt; name=&quot;hide_statistics&quot;&gt;</span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;visibility: hidden; &quot;</span>&gt;</span>　<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;text-align: center; &quot;</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;submit_button&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ui labeled icon blue button&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ui edit icon&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">$(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">  $(<span class="string">&#x27;#search_admins&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    .<span class="title function_">dropdown</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">debug</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">apiSettings</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">url</span>: <span class="string">&#x27;/api/v2/search/users/&#123;query&#125;&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">onResponse</span>: <span class="keyword">function</span> (<span class="params">response</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">var</span> a = $(<span class="string">&#x27;#search_admins&#x27;</span>).<span class="title function_">val</span>().<span class="title function_">map</span>(<span class="keyword">function</span> (<span class="params">x</span>) &#123; <span class="keyword">return</span> <span class="built_in">parseInt</span>(x) &#125;);</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">if</span> (response.<span class="property">results</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            response.<span class="property">results</span> = response.<span class="property">results</span>.<span class="title function_">filter</span>(<span class="keyword">function</span>(<span class="params">x</span>)&#123; <span class="keyword">return</span> !a.<span class="title function_">includes</span>(<span class="built_in">parseInt</span>(x.<span class="property">value</span>))&#125;);</span></span><br><span class="line"><span class="language-javascript">          &#125;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">return</span> response;</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">cache</span>: <span class="literal">false</span></span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript">  $(<span class="string">&#x27;#search_problems&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    .<span class="title function_">dropdown</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">debug</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">apiSettings</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">url</span>: <span class="string">&#x27;/api/v2/search/problems/&#123;query&#125;&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">onResponse</span>: <span class="keyword">function</span> (<span class="params">response</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">var</span> a = $(<span class="string">&#x27;#search_problems&#x27;</span>).<span class="title function_">val</span>().<span class="title function_">map</span>(<span class="keyword">function</span> (<span class="params">x</span>) &#123; <span class="keyword">return</span> <span class="built_in">parseInt</span>(x) &#125;);</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">if</span> (response.<span class="property">results</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            response.<span class="property">results</span> = response.<span class="property">results</span>.<span class="title function_">filter</span>(<span class="keyword">function</span>(<span class="params">x</span>) &#123;<span class="keyword">return</span> !a.<span class="title function_">includes</span>(<span class="built_in">parseInt</span>(x.<span class="property">value</span>));&#125;);</span></span><br><span class="line"><span class="language-javascript">          &#125;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">return</span> response;</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">cache</span>: <span class="literal">false</span></span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&lt;% include footer %&gt;</span><br></pre></td></tr></table></figure>
<p>views/contest_header.ejs：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.ui</span><span class="selector-class">.label</span><span class="selector-class">.pointing</span><span class="selector-class">.below</span><span class="selector-class">.left</span><span class="selector-pseudo">::before</span> &#123; <span class="attribute">left</span>: <span class="number">12%</span>; &#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.ui</span><span class="selector-class">.label</span><span class="selector-class">.pointing</span><span class="selector-class">.below</span><span class="selector-class">.right</span><span class="selector-pseudo">::before</span> &#123; <span class="attribute">left</span>: <span class="number">88%</span>; &#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.ui</span><span class="selector-class">.label</span><span class="selector-class">.pointing</span><span class="selector-class">.below</span><span class="selector-class">.left</span> &#123; <span class="attribute">margin-bottom</span>: <span class="number">0</span>; &#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.ui</span><span class="selector-class">.label</span><span class="selector-class">.pointing</span><span class="selector-class">.below</span><span class="selector-class">.right</span> &#123; <span class="attribute">margin-bottom</span>: <span class="number">0</span>; <span class="attribute">float</span>: right; &#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-id">#back_to_contest</span> &#123; <span class="attribute">display</span>: none;  &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;padding&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&lt;%= contest.title %&gt;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;margin-bottom: 30px;&quot;</span>&gt;</span>&lt;%- contest.subtitle %&gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  &lt;% let unveiled = (isSupervisior || syzoj.utils.getCurrentDate() &gt;= contest.start_time); %&gt;</span><br><span class="line">  &lt;% const seeResult = (isSupervisior || contest.ended); %&gt;</span><br><span class="line">  &lt;% const seeRanklist = seeResult || (contest.allowedSeeingResult() &amp;&amp; contest.allowedSeeingOthers()); %&gt;</span><br><span class="line">  &lt;% let start = syzoj.utils.formatDate(contest.start_time), end = syzoj.utils.formatDate(contest.end_time); %&gt;</span><br><span class="line">  &lt;% if (contest.running &amp;&amp; start.split(&#x27; &#x27;)[0] === end.split(&#x27; &#x27;)[0]) &#123;</span><br><span class="line">    start = start.split(&#x27; &#x27;)[1]; end = end.split(&#x27; &#x27;)[1];</span><br><span class="line">  &#125; %&gt;</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui pointing below left label&quot;</span>&gt;</span>&lt;%= start %&gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui pointing below right label&quot;</span>&gt;</span>&lt;%= end %&gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  &lt;% let timePercentage = Math.floor(Math.min(1, (syzoj.utils.getCurrentDate() - contest.start_time) / (contest.end_time - contest.start_time)) * 100); %&gt;</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;timer-progress&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ui tiny indicating progress&lt;% if (timePercentage == 100) &#123; %&gt; success&lt;% &#125; %&gt;&quot;</span> <span class="attr">data-percent</span>=<span class="string">&quot;&lt;%= timePercentage %&gt;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;bar&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: &lt;%= timePercentage %&gt;%;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui grid&quot;</span>  <span class="attr">style</span>=<span class="string">&quot;display: block;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;column&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui buttons&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;ui small orange button&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;contest&#x27;, contest.id]) %&gt;&quot;</span>&gt;</span>信息<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            &lt;% if (unveiled) &#123; %&gt;<span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;ui small yellow button&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;contest&#x27;, contest.id, &#x27;problem&#x27;]) %&gt;&quot;</span>&gt;</span>题目<span class="tag">&lt;/<span class="name">a</span>&gt;</span>&lt;% &#125; %&gt;</span><br><span class="line">          &lt;% if(seeRanklist) &#123; %&gt;</span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;ui small blue button&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;contest&#x27;, contest.id, &#x27;ranklist&#x27;]) %&gt;&quot;</span>&gt;</span>排行榜<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          &lt;% &#125; %&gt;</span><br><span class="line">          &lt;% let submissionsUrl = seeResult ?</span><br><span class="line">            syzoj.utils.makeUrl([&#x27;submissions&#x27;], &#123;contest: contest.id&#125;) :</span><br><span class="line">            syzoj.utils.makeUrl([&#x27;contest&#x27;, contest.id, &#x27;submissions&#x27;]); %&gt;</span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;ui small positive button&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;contest&#x27;, contest.id, &#x27;submissions&#x27;]) %&gt;&quot;</span>&gt;</span>提交记录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          &lt;% if (isSupervisior) &#123; %&gt;</span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;ui small button&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;contest&#x27;, contest.id, &#x27;edit&#x27;]) %&gt;&quot;</span>&gt;</span>编辑比赛<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          &lt;% &#125; %&gt;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>views/contest_footer.ejs：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">$(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="built_in">setInterval</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    $(<span class="string">&#x27;#timer-progress&#x27;</span>).<span class="title function_">progress</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">value</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>() / <span class="number">1000</span> - &lt;%= contest.<span class="property">start_time</span> %&gt;,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">total</span>: &lt;%= contest.<span class="property">end_time</span> - contest.<span class="property">start_time</span> %&gt;</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript">  &#125;, <span class="number">5000</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>views/contest.ejs：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;% this.title = contest.title + &#x27; - 比赛&#x27; %&gt;</span><br><span class="line">&lt;% include header %&gt;</span><br><span class="line">&lt;% include contest_header %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;column&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span> <span class="attr">class</span>=<span class="string">&quot;ui top attached block header&quot;</span>&gt;</span>信息与公告<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui bottom attached segment font-contest&quot;</span>&gt;</span></span><br><span class="line">      &lt;%- contest.information %&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&lt;% include contest_footer %&gt;</span><br><span class="line">&lt;% include footer %&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>views/contest_problem.ejs：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">&lt;% this.title = contest.title + &#x27; - 题目&#x27; %&gt;</span><br><span class="line">&lt;% include header %&gt;</span><br><span class="line">&lt;% include contest_header %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;column&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;ui selectable celled table&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span> <span class="attr">class</span>=<span class="string">&quot;one wide&quot;</span> <span class="attr">style</span>=<span class="string">&quot;text-align: center&quot;</span>&gt;</span>状态<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>题目<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            &lt;% if (hasStatistics) &#123; %&gt;</span><br><span class="line">              <span class="tag">&lt;<span class="name">th</span> <span class="attr">class</span>=<span class="string">&quot;one wide center aligned&quot;</span>&gt;</span>统计<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            &lt;% &#125; %&gt;</span><br><span class="line">          <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">          &lt;%</span><br><span class="line">          let i = 0;</span><br><span class="line">          for (let problem of problems) &#123;</span><br><span class="line">            i++;</span><br><span class="line">          %&gt;</span><br><span class="line">          <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;center aligned&quot;</span> <span class="attr">style</span>=<span class="string">&quot;white-space: nowrap; &quot;</span>&gt;</span></span><br><span class="line">            &lt;% if (problem.judge_id) &#123; %&gt;</span><br><span class="line">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;contest&#x27;, &#x27;submission&#x27;, problem.judge_id]) %&gt;&quot;</span>&gt;</span></span><br><span class="line">              &lt;% if (typeof problem.status === &#x27;string&#x27;) &#123; %&gt;</span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;status &lt;%= problem.status.toLowerCase().split(&#x27; &#x27;).join(&#x27;_&#x27;) %&gt;&quot;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">b</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;&lt;%= icon[getStatusMeta(problem.status)] || &#x27;remove&#x27; %&gt; icon&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                  &lt;%= problem.feedback || problem.status %&gt;</span><br><span class="line">                  <span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">              &lt;% &#125; else if (typeof problem.status === &#x27;object&#x27;) &#123; %&gt;</span><br><span class="line">                &lt;% if (problem.status.accepted) &#123; %&gt;</span><br><span class="line">                  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;score score_10&quot;</span>&gt;</span></span><br><span class="line">                    &lt;% if (problem.status.unacceptedCount === 0) &#123; %&gt;</span><br><span class="line">                      +</span><br><span class="line">                    &lt;% &#125; else &#123; %&gt;</span><br><span class="line">                      +&lt;%= problem.status.unacceptedCount %&gt;</span><br><span class="line">                    &lt;% &#125; %&gt;</span><br><span class="line">                  <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                &lt;% &#125; else &#123; %&gt;</span><br><span class="line">                  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;score score_0&quot;</span>&gt;</span></span><br><span class="line">                    &lt;% if (problem.status.unacceptedCount !== 0) &#123; %&gt;</span><br><span class="line">                      -&lt;%= problem.status.unacceptedCount %&gt;</span><br><span class="line">                    &lt;% &#125; %&gt;</span><br><span class="line">                  <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                &lt;% &#125; %&gt;</span><br><span class="line">              &lt;% &#125; %&gt;</span><br><span class="line">            &lt;% &#125; %&gt;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;contest&#x27;, contest.id, &#x27;problem&#x27;, i]) %&gt;&quot;</span>&gt;</span>&lt;%= syzoj.utils.removeTitleTag(problem.problem.title) %&gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            &lt;% if (hasStatistics) &#123; %&gt;</span><br><span class="line">              <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;center aligned&quot;</span> <span class="attr">style</span>=<span class="string">&quot;white-space: nowrap; &quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;contest&#x27;, contest.id, &#x27;submissions&#x27;], &#123; problem_id: i, status: &#x27;Accepted&#x27; &#125;) %&gt;&quot;</span>&gt;</span>&lt;%= problem.statistics.accepted %&gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">              /</span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;contest&#x27;, contest.id, &#x27;submissions&#x27;], &#123; problem_id: i, min_score: 1 &#125;) %&gt;&quot;</span>&gt;</span>&lt;%= problem.statistics.partially %&gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                &lt;% if (contest.type === &#x27;NOI&#x27; || contest.type === &#x27;IOI&#x27;) &#123; %&gt;</span><br><span class="line">                /</span><br><span class="line">              &lt;% &#125; %&gt;</span><br><span class="line">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;contest&#x27;, contest.id, &#x27;submissions&#x27;], &#123; problem_id: i &#125;) %&gt;&quot;</span>&gt;</span>&lt;%= problem.statistics.attempt %&gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            &lt;% &#125; %&gt;</span><br><span class="line">          <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        &lt;% &#125; %&gt;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&lt;% include contest_footer %&gt;</span><br><span class="line">&lt;% include footer %&gt;</span><br></pre></td></tr></table></figure>
<p>views/contest_ranklist.ejs：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line">&lt;% this.title = contest.title + &#x27; - 排名&#x27; %&gt;</span><br><span class="line">&lt;% include header %&gt;</span><br><span class="line">&lt;% include contest_header %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.submit_time</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">font-size</span>: <span class="number">0.8em</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">margin-top</span>: <span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">color</span>: <span class="number">#000</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;ui very basic center aligned table&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>#<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        &lt;% if (contest.type === &#x27;ACM&#x27;) &#123; %&gt;</span><br><span class="line">          <span class="tag">&lt;<span class="name">th</span>&gt;</span>通过数量<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">th</span>&gt;</span>罚时<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        &lt;% &#125; %&gt;</span><br><span class="line">        &lt;% for (let i = 0; i &lt; problems.length; i++) &#123; %&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;contest&#x27;, contest.id, &#x27;problem&#x27;, i + 1]) %&gt;&quot;</span>&gt;</span></span><br><span class="line">            &lt;%= syzoj.utils.removeTitleTag(problems[i].title) %&gt;</span><br><span class="line">          <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        &lt;% &#125; %&gt;</span><br><span class="line">        &lt;% if (contest.type === &#x27;NOI&#x27; || contest.type === &#x27;IOI&#x27;) &#123; %&gt;</span><br><span class="line">          <span class="tag">&lt;<span class="name">th</span>&gt;</span>总分<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        &lt;% &#125; %&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">    &lt;%</span><br><span class="line">    for (let problem of problems) &#123;</span><br><span class="line">      let i = 0, min, minPos = -1;</span><br><span class="line">      for (let item of ranklist) &#123;</span><br><span class="line">        i++;</span><br><span class="line">        let condition;</span><br><span class="line">        if (contest.type === &#x27;ACM&#x27;) condition = item.player.score_details[problem.id] &amp;&amp; item.player.score_details[problem.id].accepted &amp;&amp; (minPos === -1 || item.player.score_details[problem.id].acceptedTime &lt; min.player.score_details[problem.id].acceptedTime);</span><br><span class="line">        else condition = item.player.score_details[problem.id] &amp;&amp; item.player.score_details[problem.id].score === 100 &amp;&amp; (minPos === -1 || item.player.score_details[problem.id].judge_state.submit_time &lt; min.player.score_details[problem.id].judge_state.submit_time);</span><br><span class="line">        if (condition) &#123;</span><br><span class="line">          min = item;</span><br><span class="line">          minPos = i;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      problem.min = minPos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    let i = 0, rank = 0, lastItem;</span><br><span class="line">    for (let item of ranklist) &#123;</span><br><span class="line">      i++;</span><br><span class="line">      let latest = contest.start_time, timeSum = 0, unacceptedCount = 0;</span><br><span class="line">    %&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        &lt;%</span><br><span class="line">          if (contest.type === &#x27;NOI&#x27; || contest.type === &#x27;IOI&#x27;) &#123;</span><br><span class="line">            if (i === 1 || item.player.score !== lastItem.player.score) rank = i;</span><br><span class="line">          &#125; else if (contest.type === &#x27;ACM&#x27;) &#123;</span><br><span class="line">            for (let problem of problems) &#123;</span><br><span class="line">              if (item.player.score_details[problem.id] &amp;&amp; item.player.score_details[problem.id].accepted) &#123;</span><br><span class="line">                timeSum += (item.player.score_details[problem.id].acceptedTime - contest.start_time) + (item.player.score_details[problem.id].unacceptedCount * 20 * 60);</span><br><span class="line">                unacceptedCount += item.player.score_details[problem.id].unacceptedCount;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            item.player.timeSum = timeSum;</span><br><span class="line"></span><br><span class="line">            if (i === 1 || item.player.score !== lastItem.player.score || item.player.timeSum !== lastItem.player.timeSum) rank = i;</span><br><span class="line">          &#125;</span><br><span class="line">        %&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">          &lt;% if (rank == 1) &#123; %&gt;</span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui yellow ribbon label&quot;</span>&gt;</span></span><br><span class="line">          &lt;% &#125; else if (rank == 2) &#123; %&gt;</span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui ribbon label&quot;</span>&gt;</span></span><br><span class="line">          &lt;% &#125; else if (rank == 3) &#123; %&gt;</span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui brown ribbon label&quot;</span> <span class="attr">style</span>=<span class="string">&quot;background-color: #C47222 !important;&quot;</span>&gt;</span></span><br><span class="line">          &lt;% &#125; else &#123; %&gt;</span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">          &lt;% &#125; %&gt;</span><br><span class="line">          &lt;%= rank %&gt;</span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;user&#x27;, item.user.id]) %&gt;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-name user-&lt;%= syzoj.utils.makeUserColor(item.user.rating, item.user.is_admin) %&gt;&quot;</span>&gt;</span>&lt;%= item.user.username %&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span>&lt;% if (item.user.nickname) &#123; %&gt;<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-tag bg-&lt;%= syzoj.utils.makeUserColor(item.user.rating, item.user.is_admin) %&gt;&quot;</span>&gt;</span>&lt;%- item.user.nickname %&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&lt;% &#125; %&gt;<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-gray&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-nameplate&quot;</span>&gt;</span>&lt;%= item.user.nameplate %&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        &lt;% if (contest.type === &#x27;ACM&#x27;) &#123; %&gt;</span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;score score_&lt;%= parseInt((item.player.score / ranklist[0].player.score * 10) || 0) %&gt;&quot;</span>&gt;</span></span><br><span class="line">              &lt;%= item.player.score %&gt;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">            &lt;%= syzoj.utils.formatTime(timeSum) %&gt;</span><br><span class="line">          <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        &lt;% &#125; %&gt;</span><br><span class="line">        &lt;% for (let problem of problems) &#123; %&gt;</span><br><span class="line">          &lt;% if (problem.min === i) &#123; %&gt;</span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">style</span>=<span class="string">&quot;background: rgb(244, 255, 245); &quot;</span>&gt;</span></span><br><span class="line">          &lt;% &#125; else &#123; %&gt;</span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">          &lt;% &#125; %&gt;</span><br><span class="line">          &lt;% if (!item.player.score_details[problem.id]) &#123; %&gt;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          &lt;% &#125; else if (contest.type === &#x27;ACM&#x27;) &#123; %&gt;</span><br><span class="line">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;submission&#x27;, item.player.score_details[problem.id].judge_id]) %&gt;&quot;</span>&gt;</span></span><br><span class="line">                &lt;% if (item.player.score_details[problem.id].accepted) &#123; %&gt;</span><br><span class="line">                  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;score score_10&quot;</span>&gt;</span></span><br><span class="line">                    &lt;% if (item.player.score_details[problem.id].unacceptedCount) &#123; %&gt;</span><br><span class="line">                      +&lt;%= item.player.score_details[problem.id].unacceptedCount %&gt;</span><br><span class="line">                    &lt;% &#125; else &#123; %&gt;</span><br><span class="line">                      +</span><br><span class="line">                    &lt;% &#125; %&gt;</span><br><span class="line">                  <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;submit_time&quot;</span>&gt;</span></span><br><span class="line">                    &lt;%= syzoj.utils.formatTime(item.player.score_details[problem.id].acceptedTime - contest.start_time) %&gt;</span><br><span class="line">                  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                &lt;% &#125; else if (item.player.score_details[problem.id].unacceptedCount) &#123; %&gt;</span><br><span class="line">                  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;score score_0&quot;</span>&gt;</span></span><br><span class="line">                    -&lt;%= item.player.score_details[problem.id].unacceptedCount %&gt;</span><br><span class="line">                  <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                &lt;% &#125; %&gt;</span><br><span class="line">              <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          &lt;% &#125; else if (contest.type === &#x27;NOI&#x27; || contest.type === &#x27;IOI&#x27;) &#123; %&gt;</span><br><span class="line">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;submission&#x27;, item.player.score_details[problem.id].judge_id]) %&gt;&quot;</span>&gt;</span></span><br><span class="line">                &lt;% if (item.player.score_details[problem.id].weighted_score != null) &#123; %&gt;</span><br><span class="line">                  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;score score_&lt;%= parseInt((item.player.score_details[problem.id].score / 10) || 0) %&gt;&quot;</span>&gt;</span></span><br><span class="line">                    &lt;%= Math.round(item.player.score_details[problem.id].weighted_score) %&gt;</span><br><span class="line">                  <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                &lt;% &#125; else &#123; %&gt;</span><br><span class="line">                  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;status compile_error&quot;</span>&gt;</span></span><br><span class="line">                    0</span><br><span class="line">                  <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                &lt;% &#125; %&gt;</span><br><span class="line">              <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;submit_time&quot;</span>&gt;</span></span><br><span class="line">                &lt;%= syzoj.utils.formatTime(item.player.score_details[problem.id].judge_state.submit_time - contest.start_time) %&gt;</span><br><span class="line">                &lt;% latest = Math.max(latest, item.player.score_details[problem.id].judge_state.submit_time)  %&gt;</span><br><span class="line">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          &lt;% &#125; %&gt;</span><br><span class="line">        &lt;% &#125; %&gt;</span><br><span class="line">        &lt;% if (contest.type === &#x27;NOI&#x27; || contest.type === &#x27;IOI&#x27;) &#123; %&gt;</span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;score score_&lt;%= parseInt((item.player.score / ranklist[0].player.score * 10) || 0) %&gt;&quot;</span>&gt;</span></span><br><span class="line">              &lt;%= item.player.score %&gt;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;submit_time&quot;</span>&gt;</span></span><br><span class="line">              &lt;%= syzoj.utils.formatTime(latest - contest.start_time) %&gt;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        &lt;% &#125; %&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    &lt;% lastItem = item; %&gt;</span><br><span class="line">    &lt;% &#125; %&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">&lt;% if (!ranklist.length) &#123; %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;background-color: #fff; height: 18px; margin-top: -18px; &quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui placeholder segment&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-top: 0px; &quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui icon header&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ui file icon&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-bottom: 20px; &quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">    暂无选手提交</span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&lt;% &#125; %&gt;</span><br><span class="line">&lt;% include contest_footer %&gt;</span><br><span class="line">&lt;% include footer %&gt;</span><br></pre></td></tr></table></figure>
<h2 id="作业功能">作业功能</h2>
<p>教练要求可以布置作业，但是 SYZOJ
并没有这个功能，所以需要自己写一个。</p>
<p>因为和比赛很像，所以前后端都可以从比赛功能抄一些代码。</p>
<p>首先定义一个用于存数据的表，新建 models/homework.ts：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">TypeORM</span> <span class="keyword">from</span> <span class="string">&quot;typeorm&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Model</span> <span class="keyword">from</span> <span class="string">&quot;./common&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">var</span> syzoj, <span class="title class_">ErrorMessage</span>: <span class="built_in">any</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">User</span> <span class="keyword">from</span> <span class="string">&quot;./user&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Problem</span> <span class="keyword">from</span> <span class="string">&quot;./problem&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@TypeORM</span>.<span class="title class_">Entity</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Homework</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> cache = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@TypeORM</span>.<span class="title class_">PrimaryGeneratedColumn</span>()</span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@TypeORM</span>.<span class="title class_">Column</span>(&#123; <span class="attr">nullable</span>: <span class="literal">true</span>, <span class="attr">type</span>: <span class="string">&quot;varchar&quot;</span>, <span class="attr">length</span>: <span class="number">80</span> &#125;)</span><br><span class="line">  <span class="attr">title</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@TypeORM</span>.<span class="title class_">Column</span>(&#123; <span class="attr">nullable</span>: <span class="literal">true</span>, <span class="attr">type</span>: <span class="string">&quot;text&quot;</span> &#125;)</span><br><span class="line">  <span class="attr">subtitle</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@TypeORM</span>.<span class="title class_">Column</span>(&#123; <span class="attr">nullable</span>: <span class="literal">true</span>, <span class="attr">type</span>: <span class="string">&quot;text&quot;</span> &#125;)</span><br><span class="line">  <span class="attr">information</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@TypeORM</span>.<span class="title class_">Column</span>(&#123; <span class="attr">nullable</span>: <span class="literal">true</span>, <span class="attr">type</span>: <span class="string">&quot;text&quot;</span> &#125;)</span><br><span class="line">  <span class="attr">problems</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@TypeORM</span>.<span class="title class_">Column</span>(&#123; <span class="attr">nullable</span>: <span class="literal">true</span>, <span class="attr">type</span>: <span class="string">&quot;text&quot;</span> &#125;)</span><br><span class="line">  <span class="attr">users</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@TypeORM</span>.<span class="title class_">Column</span>(&#123; <span class="attr">nullable</span>: <span class="literal">true</span>, <span class="attr">type</span>: <span class="string">&quot;boolean&quot;</span> &#125;)</span><br><span class="line">  <span class="attr">is_public</span>: <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">getUsers</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">users</span>) <span class="keyword">return</span> [];</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">users</span>.<span class="title function_">split</span>(<span class="string">&#x27;|&#x27;</span>).<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="built_in">parseInt</span>(x));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">getProblems</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">problems</span>) <span class="keyword">return</span> [];</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">problems</span>.<span class="title function_">split</span>(<span class="string">&#x27;|&#x27;</span>).<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> <span class="built_in">parseInt</span>(x));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">setProblemsNoCheck</span>(<span class="params">problemIDs</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">problems</span> = problemIDs.<span class="title function_">join</span>(<span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">setProblems</span>(<span class="params">s</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> a = [];</span><br><span class="line">    <span class="keyword">await</span> s.<span class="title function_">split</span>(<span class="string">&#x27;|&#x27;</span>).<span class="title function_">forEachAsync</span>(<span class="keyword">async</span> x =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> problem = <span class="keyword">await</span> <span class="title class_">Problem</span>.<span class="title function_">findById</span>(x);</span><br><span class="line">      <span class="keyword">if</span> (!problem) <span class="keyword">return</span>;</span><br><span class="line">      a.<span class="title function_">push</span>(x);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">problems</span> = a.<span class="title function_">join</span>(<span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后修改后端代码，新建 modules/homework.js：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="title class_">Homework</span> = syzoj.<span class="title function_">model</span>(<span class="string">&#x27;homework&#x27;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="title class_">Problem</span> = syzoj.<span class="title function_">model</span>(<span class="string">&#x27;problem&#x27;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="title class_">User</span> = syzoj.<span class="title function_">model</span>(<span class="string">&#x27;user&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="property">get</span> (<span class="string">&#x27;/homeworks&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;请登录后继续。&#x27;</span>, &#123; <span class="string">&#x27;登录&#x27;</span>: syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;login&#x27;</span>], &#123; <span class="string">&#x27;url&#x27;</span>: req.<span class="property">originalUrl</span> &#125;) &#125;);</span><br><span class="line">    <span class="keyword">let</span> where;</span><br><span class="line">    <span class="keyword">if</span> (res.<span class="property">locals</span>.<span class="property">user</span> &amp;&amp; res.<span class="property">locals</span>.<span class="property">user</span>.<span class="property">is_admin</span>) where = &#123;&#125;</span><br><span class="line">    <span class="keyword">else</span> where = &#123; <span class="attr">is_public</span>: <span class="literal">true</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> paginate = syzoj.<span class="property">utils</span>.<span class="title function_">paginate</span>(<span class="keyword">await</span> <span class="title class_">Homework</span>.<span class="title function_">countForPagination</span>(where), req.<span class="property">query</span>.<span class="property">page</span>, syzoj.<span class="property">config</span>.<span class="property">page</span>.<span class="property">contest</span>);</span><br><span class="line">    <span class="keyword">let</span> homeworks = <span class="keyword">await</span> <span class="title class_">Homework</span>.<span class="property">queryPage</span> (paginate, where);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> homeworks.<span class="title function_">forEachAsync</span>(<span class="keyword">async</span> x =&gt; x.<span class="property">subtitle</span> = <span class="keyword">await</span> syzoj.<span class="property">utils</span>.<span class="title function_">markdown</span>(x.<span class="property">subtitle</span>));</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;homeworks&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">homeworks</span>: homeworks,</span><br><span class="line">      <span class="attr">paginate</span>: paginate</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    syzoj.<span class="title function_">log</span>(e);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">err</span>: e</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/homework/:id/edit&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;请登录后继续。&#x27;</span>, &#123; <span class="string">&#x27;登录&#x27;</span>: syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;login&#x27;</span>], &#123; <span class="string">&#x27;url&#x27;</span>: req.<span class="property">originalUrl</span> &#125;) &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span> || !res.<span class="property">locals</span>.<span class="property">user</span>.<span class="property">is_admin</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;您没有权限进行此操作。&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> homework_id = <span class="built_in">parseInt</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">let</span> homework = <span class="keyword">await</span> <span class="title class_">Homework</span>.<span class="title function_">findById</span>(homework_id);</span><br><span class="line">    <span class="keyword">if</span> (!homework) &#123;</span><br><span class="line">      homework = <span class="keyword">await</span> <span class="title class_">Homework</span>.<span class="title function_">create</span>();</span><br><span class="line">      homework.<span class="property">id</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> problems = [], users_id = [];</span><br><span class="line">    <span class="keyword">if</span> (homework.<span class="property">problems</span>) problems = <span class="keyword">await</span> homework.<span class="property">problems</span>.<span class="title function_">split</span>(<span class="string">&#x27;|&#x27;</span>).<span class="title function_">mapAsync</span>(<span class="keyword">async</span> id =&gt; <span class="keyword">await</span> <span class="title class_">Problem</span>.<span class="title function_">findById</span>(id));</span><br><span class="line">    <span class="keyword">if</span> (homework.<span class="property">users</span>) users_id = <span class="keyword">await</span> homework.<span class="property">users</span>.<span class="title function_">split</span>(<span class="string">&#x27;|&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> items = [];</span><br><span class="line">    <span class="keyword">let</span> user_count = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="property">count</span> ();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> user_id = <span class="number">1</span>; user_id &lt;= user_count; ++user_id) &#123;</span><br><span class="line">      items.<span class="property">push</span> ([<span class="keyword">await</span> <span class="title class_">User</span>.<span class="property">findById</span> (user_id), users_id.<span class="property">includes</span> (user_id.<span class="property">toString</span> ())]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;homework_edit&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">homework</span>: homework,</span><br><span class="line">      <span class="attr">problems</span>: problems,</span><br><span class="line">      <span class="attr">items</span>: items</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    syzoj.<span class="title function_">log</span>(e);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">err</span>: e</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/homework/:id/edit&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;请登录后继续。&#x27;</span>, &#123; <span class="string">&#x27;登录&#x27;</span>: syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;login&#x27;</span>], &#123; <span class="string">&#x27;url&#x27;</span>: req.<span class="property">originalUrl</span> &#125;) &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span> || !res.<span class="property">locals</span>.<span class="property">user</span>.<span class="property">is_admin</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;您没有权限进行此操作。&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> homework_id = <span class="built_in">parseInt</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">let</span> homework = <span class="keyword">await</span> <span class="title class_">Homework</span>.<span class="title function_">findById</span>(homework_id);</span><br><span class="line">    <span class="keyword">if</span> (!homework) &#123;</span><br><span class="line">      homework = <span class="keyword">await</span> <span class="title class_">Homework</span>.<span class="title function_">create</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!req.<span class="property">body</span>.<span class="property">title</span>.<span class="title function_">trim</span>()) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;作业名不能为空。&#x27;</span>);</span><br><span class="line">    homework.<span class="property">title</span> = req.<span class="property">body</span>.<span class="property">title</span>;</span><br><span class="line">    homework.<span class="property">subtitle</span> = req.<span class="property">body</span>.<span class="property">subtitle</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(req.<span class="property">body</span>.<span class="property">problems</span>)) req.<span class="property">body</span>.<span class="property">problems</span> = [req.<span class="property">body</span>.<span class="property">problems</span>];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(req.<span class="property">body</span>.<span class="property">items</span>)) req.<span class="property">body</span>.<span class="property">items</span> = [req.<span class="property">body</span>.<span class="property">items</span>];</span><br><span class="line">    homework.<span class="property">problems</span> = req.<span class="property">body</span>.<span class="property">problems</span>.<span class="title function_">join</span>(<span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">    homework.<span class="property">information</span> = req.<span class="property">body</span>.<span class="property">information</span>;</span><br><span class="line">    homework.<span class="property">is_public</span> = req.<span class="property">body</span>.<span class="property">is_public</span> === <span class="string">&#x27;on&#x27;</span>;</span><br><span class="line">    homework.<span class="property">users</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> user <span class="keyword">of</span> req.<span class="property">body</span>.<span class="property">items</span>) &#123;</span><br><span class="line">      homework.<span class="property">users</span> += user + <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    homework.<span class="property">users</span> = homework.<span class="property">users</span>.<span class="property">substr</span> (<span class="number">0</span>, homework.<span class="property">users</span>.<span class="property">length</span> - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> homework.<span class="title function_">save</span>();</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">redirect</span>(syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;homework&#x27;</span>, homework.<span class="property">id</span>]));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    syzoj.<span class="title function_">log</span>(e);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">err</span>: e</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/homework/:id&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;请登录后继续。&#x27;</span>, &#123; <span class="string">&#x27;登录&#x27;</span>: syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;login&#x27;</span>], &#123; <span class="string">&#x27;url&#x27;</span>: req.<span class="property">originalUrl</span> &#125;) &#125;);</span><br><span class="line">    <span class="keyword">const</span> curUser = res.<span class="property">locals</span>.<span class="property">user</span>;</span><br><span class="line">    <span class="keyword">let</span> homework_id = <span class="built_in">parseInt</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> homework = <span class="keyword">await</span> <span class="title class_">Homework</span>.<span class="title function_">findById</span>(homework_id);</span><br><span class="line">    <span class="keyword">if</span> (!homework) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;无此作业。&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!homework.<span class="property">is_public</span> &amp;&amp; (!res.<span class="property">locals</span>.<span class="property">user</span> || !res.<span class="property">locals</span>.<span class="property">user</span>.<span class="property">is_admin</span>)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;您无权查看此作业。&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> isSupervisior = res.<span class="property">locals</span>.<span class="property">user</span>.<span class="property">is_admin</span>;</span><br><span class="line">    homework.<span class="property">subtitle</span> = <span class="keyword">await</span> syzoj.<span class="property">utils</span>.<span class="title function_">markdown</span>(homework.<span class="property">subtitle</span>);</span><br><span class="line">    homework.<span class="property">information</span> = <span class="keyword">await</span> syzoj.<span class="property">utils</span>.<span class="title function_">markdown</span>(homework.<span class="property">information</span>);</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;homework&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">homework</span>: homework,</span><br><span class="line">      <span class="attr">isSupervisior</span>: isSupervisior</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    syzoj.<span class="title function_">log</span>(e);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">err</span>: e</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/homework/:id/problem&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;请登录后继续。&#x27;</span>, &#123; <span class="string">&#x27;登录&#x27;</span>: syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;login&#x27;</span>], &#123; <span class="string">&#x27;url&#x27;</span>: req.<span class="property">originalUrl</span> &#125;) &#125;);</span><br><span class="line">    <span class="keyword">const</span> curUser = res.<span class="property">locals</span>.<span class="property">user</span>;</span><br><span class="line">    <span class="keyword">let</span> homework_id = <span class="built_in">parseInt</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> homework = <span class="keyword">await</span> <span class="title class_">Homework</span>.<span class="title function_">findById</span>(homework_id);</span><br><span class="line">    <span class="keyword">if</span> (!homework) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;无此作业。&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!homework.<span class="property">is_public</span> &amp;&amp; (!curUser || !curUser.<span class="property">is_admin</span>)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;您无权查看此作业。&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> isSupervisior = curUser.<span class="property">is_admin</span>;</span><br><span class="line">    homework.<span class="property">subtitle</span> = <span class="keyword">await</span> syzoj.<span class="property">utils</span>.<span class="title function_">markdown</span>(homework.<span class="property">subtitle</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> problems_id = <span class="keyword">await</span> homework.<span class="title function_">getProblems</span>();</span><br><span class="line">    <span class="keyword">let</span> problems = <span class="keyword">await</span> problems_id.<span class="title function_">mapAsync</span>(<span class="keyword">async</span> id =&gt; <span class="keyword">await</span> <span class="title class_">Problem</span>.<span class="title function_">findById</span>(id));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> state = [];</span><br><span class="line">    <span class="keyword">let</span> users_id = <span class="keyword">await</span> homework.<span class="property">users</span>.<span class="property">split</span> (<span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (users_id.<span class="property">includes</span> (curUser.<span class="property">id</span>.<span class="property">toString</span> ())) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> problem <span class="keyword">of</span> problems) &#123;</span><br><span class="line">        state.<span class="property">push</span> (<span class="keyword">await</span> curUser.<span class="property">getProblemScore</span> (problem.<span class="property">id</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;homework_problem&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">homework</span>: homework,</span><br><span class="line">      <span class="attr">problems</span>: problems,</span><br><span class="line">      <span class="attr">state</span>: state,</span><br><span class="line">      <span class="attr">isSupervisior</span>: isSupervisior</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    syzoj.<span class="title function_">log</span>(e);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">err</span>: e</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/homework/:id/ranklist&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!res.<span class="property">locals</span>.<span class="property">user</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;请登录后继续。&#x27;</span>, &#123; <span class="string">&#x27;登录&#x27;</span>: syzoj.<span class="property">utils</span>.<span class="title function_">makeUrl</span>([<span class="string">&#x27;login&#x27;</span>], &#123; <span class="string">&#x27;url&#x27;</span>: req.<span class="property">originalUrl</span> &#125;) &#125;);</span><br><span class="line">    <span class="keyword">let</span> homework_id = <span class="built_in">parseInt</span>(req.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">let</span> homework = <span class="keyword">await</span> <span class="title class_">Homework</span>.<span class="title function_">findById</span>(homework_id);</span><br><span class="line">    <span class="keyword">const</span> curUser = res.<span class="property">locals</span>.<span class="property">user</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!homework) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;无此作业。&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!homework.<span class="property">is_public</span> &amp;&amp; (!res.<span class="property">locals</span>.<span class="property">user</span> || !res.<span class="property">locals</span>.<span class="property">user</span>.<span class="property">is_admin</span>)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ErrorMessage</span>(<span class="string">&#x27;您无权查看此作业。&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> isSupervisior = res.<span class="property">locals</span>.<span class="property">user</span>.<span class="property">is_admin</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> problems_id = <span class="keyword">await</span> homework.<span class="title function_">getProblems</span>();</span><br><span class="line">    <span class="keyword">let</span> problems = <span class="keyword">await</span> problems_id.<span class="title function_">mapAsync</span>(<span class="keyword">async</span> id =&gt; <span class="keyword">await</span> <span class="title class_">Problem</span>.<span class="title function_">findById</span>(id));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> users = <span class="keyword">await</span> homework.<span class="property">getUsers</span> ();</span><br><span class="line">    users = <span class="keyword">await</span> users.<span class="title function_">mapAsync</span>(<span class="keyword">async</span> id =&gt; <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findById</span>(id));</span><br><span class="line">    <span class="keyword">let</span> ranklist = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> user <span class="keyword">of</span> users) &#123;</span><br><span class="line">      <span class="keyword">let</span> state = [user];</span><br><span class="line">      <span class="keyword">let</span> sum = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> problem <span class="keyword">of</span> problems) &#123;</span><br><span class="line">        <span class="keyword">let</span> score = <span class="keyword">await</span> user.<span class="property">getProblemScore</span> (problem.<span class="property">id</span>);</span><br><span class="line">        state.<span class="property">push</span> (score);</span><br><span class="line">        sum += score;</span><br><span class="line">      &#125;</span><br><span class="line">      state.<span class="property">push</span> (sum);</span><br><span class="line">      ranklist.<span class="property">push</span> (state);</span><br><span class="line">    &#125;</span><br><span class="line">    ranklist.<span class="property">sort</span> (<span class="keyword">function</span> (<span class="params">a, b</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (a[a.<span class="property">length</span> - <span class="number">1</span>] &gt; b[b.<span class="property">length</span> - <span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (a[a.<span class="property">length</span> - <span class="number">1</span>] == b[b.<span class="property">length</span> - <span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;homework_ranklist&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">homework</span>: homework,</span><br><span class="line">      <span class="attr">problems</span>: problems,</span><br><span class="line">      <span class="attr">ranklist</span>: ranklist,</span><br><span class="line">      <span class="attr">isSupervisior</span>: isSupervisior</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    syzoj.<span class="title function_">log</span>(e);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">err</span>: e</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>前端部分虽然要写的代码很多，但与比赛页面几乎一样，除了完成情况需要重写，其他页面可以直接从比赛部分抄然后修改一下。</p>
<p>views/homeworks.ejs：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&lt;% this.title = &#x27;作业&#x27; %&gt;</span><br><span class="line">&lt;% include header %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;padding&quot;</span>&gt;</span></span><br><span class="line">    &lt;% if (homeworks.length) &#123; %&gt;</span><br><span class="line">    &lt;% if (user &amp;&amp; user.is_admin) &#123; %&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">&quot;ui mini form&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inline fields&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-bottom: 25px; white-space: nowrap; &quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;homework&#x27;, 0, &#x27;edit&#x27;]) %&gt;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ui mini labeled icon right floated button&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-left: auto; &quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ui icon write&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">          新建作业</span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    &lt;% &#125; %&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;ui very basic center aligned table&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;float:left; margin-left: 20px;&quot;</span>&gt;</span>作业名称<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">th</span> <span class="attr">style</span>=<span class="string">&quot;text-align: left; width: 70%;&quot;</span>&gt;</span>描述<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">        &lt;% for (let homework of homeworks) &#123; %&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">style</span>=<span class="string">&quot;float:left; margin-left: 20px;&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;homework&#x27;, homework.id]) %&gt;&quot;</span>&gt;</span>&lt;%= homework.title %&gt; &lt;% if (!homework.is_public) &#123; %&gt;<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;ui header&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui tiny red label&quot;</span>&gt;</span>未布置<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>&lt;% &#125; %&gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;font-content&quot;</span> <span class="attr">style</span>=<span class="string">&quot;text-align: left;&quot;</span>&gt;</span>&lt;%- homework.subtitle %&gt;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        &lt;% &#125; %&gt;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    &lt;% &#125; else &#123; %&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui placeholder segment&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui icon header&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;calendar icon&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-bottom: 20px; &quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        暂无作业</span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      &lt;% if (user &amp;&amp; user.is_admin) &#123; %&gt;</span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;homework&#x27;, 0, &#x27;edit&#x27;]) %&gt;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ui primary labeled icon button&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ui icon write&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        布置第一份作业</span><br><span class="line">      <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      &lt;% &#125; %&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    &lt;% &#125; %&gt;</span><br><span class="line">  <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">  &lt;% include page %&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&lt;% include footer %&gt;</span><br></pre></td></tr></table></figure>
<p>views/homework_edit.ejs：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&lt;% this.title = homework.id ? &#x27;编辑作业&#x27; : &#x27;新建作业&#x27; %&gt;</span><br><span class="line">&lt;% include header %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;padding&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;homework&#x27;, homework.id, &#x27;edit&#x27;]) %&gt;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui form&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span>&gt;</span>作业名称<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;title&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&lt;%= homework.title %&gt;&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span>&gt;</span>作业描述<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;subtitle&quot;</span> <span class="attr">class</span>=<span class="string">&quot;markdown-edit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&lt;%= homework.subtitle %&gt;&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span>&gt;</span>题目列表<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">select</span> <span class="attr">class</span>=<span class="string">&quot;ui fluid search dropdown&quot;</span> <span class="attr">multiple</span>=<span class="string">&quot;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;search_problems&quot;</span> <span class="attr">name</span>=<span class="string">&quot;problems&quot;</span>&gt;</span></span><br><span class="line">                &lt;% for (let problem of problems) &#123; %&gt;</span><br><span class="line">                <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;&lt;%= problem.id %&gt;&quot;</span> <span class="attr">selected</span>&gt;</span>#&lt;%= problem.id %&gt;. &lt;%= problem.title %&gt;<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">                &lt;% &#125; %&gt;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inline fields&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span>&gt;</span>参与成员<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                &lt;% for (let item of items) &#123; %&gt;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">input</span> <span class="attr">style</span>=<span class="string">&quot;vertical-align: middle;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;items&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&lt;%= item[0].id %&gt;&quot;</span> &lt;% <span class="attr">if</span> (<span class="attr">item</span>[<span class="attr">1</span>]) &#123; %&gt;</span> checked=&quot;checked&quot;&lt;% &#125; %&gt;&gt;</span><br><span class="line">                            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;condition_participate&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-name user-&lt;%= syzoj.utils.makeUserColor(item[0].rating, item[0].is_admin) %&gt;&quot;</span>&gt;</span>&lt;%= item[0].username %&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-gray&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-nameplate&quot;</span>&gt;</span>&lt;%= item[0].nameplate %&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                &lt;% &#125; %&gt;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;field&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span>&gt;</span>作业公告<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">rows</span>=<span class="string">&quot;5&quot;</span> <span class="attr">name</span>=<span class="string">&quot;information&quot;</span> <span class="attr">class</span>=<span class="string">&quot;markdown-edit&quot;</span>&gt;</span>&lt;%= homework.information %&gt;<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inline field&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">&quot;ui header&quot;</span>&gt;</span>布置<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui toggle checkbox&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span>&lt;% <span class="attr">if</span> (<span class="attr">homework.is_public</span>) &#123; %&gt;</span> checked&lt;% &#125; %&gt; name=&quot;is_public&quot;&gt;</span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;visibility: hidden; &quot;</span>&gt;</span>　<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;text-align: center; &quot;</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;submit_button&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ui labeled icon blue button&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;ui edit icon&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">$(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">  $(<span class="string">&#x27;#search_problems&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    .<span class="title function_">dropdown</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">debug</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">apiSettings</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">url</span>: <span class="string">&#x27;/api/v2/search/problems/&#123;query&#125;&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">onResponse</span>: <span class="keyword">function</span> (<span class="params">response</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">var</span> a = $(<span class="string">&#x27;#search_problems&#x27;</span>).<span class="title function_">val</span>().<span class="title function_">map</span>(<span class="keyword">function</span> (<span class="params">x</span>) &#123; <span class="keyword">return</span> <span class="built_in">parseInt</span>(x) &#125;);</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">if</span> (response.<span class="property">results</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            response.<span class="property">results</span> = response.<span class="property">results</span>.<span class="title function_">filter</span>(<span class="keyword">function</span>(<span class="params">x</span>) &#123;<span class="keyword">return</span> !a.<span class="title function_">includes</span>(<span class="built_in">parseInt</span>(x.<span class="property">value</span>));&#125;);</span></span><br><span class="line"><span class="language-javascript">          &#125;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">return</span> response;</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">cache</span>: <span class="literal">false</span></span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&lt;% include footer %&gt;</span><br></pre></td></tr></table></figure>
<p>views/homework_header.ejs：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.ui</span><span class="selector-class">.label</span><span class="selector-class">.pointing</span><span class="selector-class">.below</span><span class="selector-class">.left</span><span class="selector-pseudo">::before</span> &#123; <span class="attribute">left</span>: <span class="number">12%</span>; &#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.ui</span><span class="selector-class">.label</span><span class="selector-class">.pointing</span><span class="selector-class">.below</span><span class="selector-class">.right</span><span class="selector-pseudo">::before</span> &#123; <span class="attribute">left</span>: <span class="number">88%</span>; &#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.ui</span><span class="selector-class">.label</span><span class="selector-class">.pointing</span><span class="selector-class">.below</span><span class="selector-class">.left</span> &#123; <span class="attribute">margin-bottom</span>: <span class="number">0</span>; &#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.ui</span><span class="selector-class">.label</span><span class="selector-class">.pointing</span><span class="selector-class">.below</span><span class="selector-class">.right</span> &#123; <span class="attribute">margin-bottom</span>: <span class="number">0</span>; <span class="attribute">float</span>: right; &#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-id">#back_to_homework</span> &#123; <span class="attribute">display</span>: none;  &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;padding&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&lt;%= homework.title %&gt;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;margin-bottom: 30px;&quot;</span>&gt;</span>&lt;%- homework.subtitle %&gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui grid&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display: block;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;column&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui buttons&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;ui small orange button&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;homework&#x27;, homework.id]) %&gt;&quot;</span>&gt;</span>信息<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;ui small yellow button&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;homework&#x27;, homework.id, &#x27;problem&#x27;]) %&gt;&quot;</span>&gt;</span>题目<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;ui small blue button&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;homework&#x27;, homework.id, &#x27;ranklist&#x27;]) %&gt;&quot;</span>&gt;</span>完成情况<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          &lt;% if (isSupervisior) &#123; %&gt;</span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;ui small button&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;homework&#x27;, homework.id, &#x27;edit&#x27;]) %&gt;&quot;</span>&gt;</span>编辑作业<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          &lt;% &#125; %&gt;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>views/homework_footer.ejs：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>views/homework.ejs：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;% this.title = homework.title + &#x27; - 作业&#x27; %&gt;</span><br><span class="line">&lt;% include header %&gt;</span><br><span class="line">&lt;% include homework_header %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;column&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span> <span class="attr">class</span>=<span class="string">&quot;ui top attached block header&quot;</span>&gt;</span>信息与公告<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;ui bottom attached segment font-content&quot;</span>&gt;</span></span><br><span class="line">      &lt;%- homework.information %&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&lt;% include homework_footer %&gt;</span><br><span class="line">&lt;% include footer %&gt;</span><br></pre></td></tr></table></figure>
<p>views/homework_problem.ejs：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt;% this.title = homework.title + &#x27; - 题目&#x27; %&gt;</span><br><span class="line">&lt;% include header %&gt;</span><br><span class="line">&lt;% include homework_header %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;column&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;ui selectable celled table&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            &lt;% if (state.length) &#123; %&gt;</span><br><span class="line">              <span class="tag">&lt;<span class="name">th</span> <span class="attr">class</span>=<span class="string">&quot;one wide&quot;</span> <span class="attr">style</span>=<span class="string">&quot;text-align: center&quot;</span>&gt;</span>状态<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            &lt;% &#125; %&gt;</span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>题目<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">          &lt;%</span><br><span class="line">          let i = 0;</span><br><span class="line">          for (let problem of problems) &#123;</span><br><span class="line">          %&gt;</span><br><span class="line">          <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            &lt;% if (state.length) &#123; %&gt;</span><br><span class="line">              <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;center aligned&quot;</span> <span class="attr">style</span>=<span class="string">&quot;white-space: nowrap; &quot;</span>&gt;</span></span><br><span class="line">              &lt;% if (state[i] != null) &#123; %&gt;</span><br><span class="line">                <span class="tag">&lt;<span class="name">b</span>&gt;</span></span><br><span class="line">                  &lt;% if (state[i] == 100) &#123; %&gt;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;check icon score_10&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                  &lt;% &#125; else &#123; %&gt;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;score score_&lt;%= parseInt (state[i] / 10) %&gt;&quot;</span>&gt;</span>&lt;%= state[i] %&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                  &lt;% &#125; %&gt;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">              &lt;% &#125; %&gt;</span><br><span class="line">              <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            &lt;% &#125; %&gt;</span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;problem&#x27;, problem.id]) %&gt;&quot;</span>&gt;</span>&lt;%= syzoj.utils.removeTitleTag(problem.title) %&gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        &lt;%</span><br><span class="line">          i++;</span><br><span class="line">        &#125;</span><br><span class="line">        %&gt;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&lt;% include homework_footer %&gt;</span><br><span class="line">&lt;% include footer %&gt;</span><br></pre></td></tr></table></figure>
<p>views/homework_ranklist.ejs：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;% this.title = homework.title + &#x27; - 完成情况&#x27; %&gt;</span><br><span class="line">&lt;% include header %&gt;</span><br><span class="line">&lt;% include homework_header %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.submit_time</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">font-size</span>: <span class="number">0.8em</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">margin-top</span>: <span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">color</span>: <span class="number">#000</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;ui very basic center aligned table&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        &lt;% for (let problem of problems) &#123; %&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;problem&#x27;, problem.id]) %&gt;&quot;</span>&gt;</span></span><br><span class="line">            &lt;%= syzoj.utils.removeTitleTag(problem.title) %&gt;</span><br><span class="line">          <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        &lt;% &#125; %&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">      &lt;% for (let item of ranklist) &#123; %&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= syzoj.utils.makeUrl([&#x27;user&#x27;, item[0].id]) %&gt;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-name user-&lt;%= syzoj.utils.makeUserColor(item[0].rating, item[0].is_admin) %&gt;&quot;</span>&gt;</span>&lt;%= item[0].username %&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span>&lt;% if (item[0].nickname) &#123; %&gt;<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-tag bg-&lt;%= syzoj.utils.makeUserColor(item[0].rating, item[0].is_admin) %&gt;&quot;</span>&gt;</span>&lt;%- item[0].nickname %&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&lt;% &#125; %&gt;<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-gray&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-nameplate&quot;</span>&gt;</span>&lt;%= item[0].nameplate %&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          &lt;%</span><br><span class="line">          let i = 1;</span><br><span class="line">          for (let problem of problems) &#123;</span><br><span class="line">          %&gt;</span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">              &lt;% if (item[i] != null) &#123; %&gt;</span><br><span class="line">                <span class="tag">&lt;<span class="name">b</span>&gt;</span></span><br><span class="line">                  &lt;% if (item[i] == 100) &#123; %&gt;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;check icon score_10&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                  &lt;% &#125; else &#123; %&gt;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;score score_&lt;%= parseInt (item[i] / 10) %&gt;&quot;</span>&gt;</span>&lt;%= item[i] %&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                  &lt;% &#125; %&gt;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">              &lt;% &#125; %&gt;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          &lt;%</span><br><span class="line">            ++i;</span><br><span class="line">          &#125;</span><br><span class="line">          %&gt;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      &lt;% &#125; %&gt; </span><br><span class="line">    <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">&lt;% include homework_footer %&gt;</span><br><span class="line">&lt;% include footer %&gt;</span><br></pre></td></tr></table></figure>
<p>最后，需要顶栏中显示作业按钮，所以在 views/header.ejs
中加入以下代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;item&lt;% if (active.startsWith(&#x27;homework&#x27;)) &#123; %&gt; active&lt;% &#125; %&gt;&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/homeworks&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;book icon&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 作业<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div></div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="zhjxaoini 微信">
        <span>微信</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>zhjxaoini
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://blog.zhaojinxi.top/2020/07/30/SYZOJ-bu-shu-mo-gai-ji-lu/" title="SYZOJ 部署&amp;魔改记录">http://blog.zhaojinxi.top/2020/07/30/SYZOJ-bu-shu-mo-gai-ji-lu/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-ND</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/OJ/" rel="tag"><i class="fa fa-tag"></i> OJ</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
            </div>
            <div class="post-nav-item">
                <a href="/2020/11/14/CSP-S2020-shan-xi-mi-huo-xing-wei-dai-shang/" rel="next" title="CSP-S2020 山 西 迷 惑 行 为 大 赏">
                  CSP-S2020 山 西 迷 惑 行 为 大 赏 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhjxaoini</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  



  <script src="/js/third-party/fancybox.js"></script>


  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
